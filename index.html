<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASTIK GBQ+ Verse Filter</title>
  <meta property="og:title" content="SASTIK GBQ+ Verse">
  <meta property="og:description" content="Explore categorized theological verses from the Gita, Bible, Quran, and more.">
  <meta property="og:image" content="https://subhendug1793.github.io/verse-viewer/images/sastik_logo.png">
  <meta property="og:url" content="https://subhendug1793.github.io/verse-viewer/">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f9f9f9; 
      position: relative; 
      min-height: 100vh; 
      display: flex;
      flex-direction: column;
    }
    .header-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .header-info { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      font-size: 0.9em; 
      color: #666; 
      z-index: 10; 
    }
    .header-info .last-updated a {
      color: #0066cc;
      text-decoration: none;
    }
    .header-info .visitor-count {
      margin-left: 20px;
      vertical-align: middle;
      display: inline-block;
      min-height: 20px; 
      font-weight: bold;
      color: #333;
      z-index: 10;
    }
    .header-info .visitor-count.error {
      font-weight: normal;
      color: #999;
    }
    .logo { 
      width: 80px; 
      height: auto; 
      margin-right: 10px; 
    }
    h2 { 
      color: #0066cc;
      text-align: center; 
      margin: 0; 
      font-size: 1.8em;
      font-weight: bold; 
      white-space: nowrap; 
      text-decoration: none; 
    }
    h2 a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    h2 a:hover { 
      text-decoration: underline; 
    }
    .mission-statement { 
      text-align: center; 
      margin: 0 auto 10px;
      max-width: 80%; 
      font-size: 1.1em; 
      line-height: 1.5; 
      font-weight: bold; 
    }
    .mission-subtext { 
      text-align: center; 
      margin: 0 auto 20px; 
      max-width: 80%; 
      font-size: 0.8em;
      line-height: 1.2; 
      font-weight: normal; 
    }
    .controls { 
      margin-bottom: 10px; 
      text-align: center; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 2px; 
      flex-wrap: wrap; 
    }
    .search-row { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 5px;
    }
    .content-count, .match-count { 
      font-size: 1em; 
      color: #333; 
      text-align: left; 
    }
    .search-input-container {
      flex-grow: 0;
      text-align: center;
    }
    select, input { 
      padding: 5px; 
      margin-right: 10px; 
    }
    select:disabled, input:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }
    #searchInput { 
      width: 200px; 
    }
    .verse-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .verse-item {
      background: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 100%;
      transition: transform 0.3s;
    }
    .verse-item:hover {
      transform: translateY(-5px);
    }
    .verse-header {
      font-size: 1.5em;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 10px;
    }
    .verse-details {
      margin-bottom: 10px;
    }
    .verse-details div {
      margin: 5px 0;
    }
    .verse-details strong {
      display: inline-block;
      width: 200px;
      font-weight: bold;
      color: #0066cc;
    }
    .category-universal { background-color: #00FF00; }
    .category-general { background-color: #00FFFF; }
    .category-controversial { background-color: #FFFF00; }
    .category-divisive { background-color: #FF0000; }
    .category-violent { background-color: #000000; color: #FFFFFF; }
    mark { 
      background-color: yellow; 
      font-weight: bold; 
    }
    .see-full-verse {
      display: inline-block;
      padding: 8px 15px;
      background: #0066cc;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .see-full-verse:hover {
      background: #005bb5;
    }
    .share-buttons {
      display: flex;
      gap: 5px;
      align-items: center;
      margin-top: 10px;
    }
    .share-buttons img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
    }
    @media (max-width: 600px) {
      .header-info { 
        position: relative; 
        top: 0; 
        right: 0; 
        text-align: center; 
        margin: 10px 0; 
        font-size: 0.8em; 
      }
      .header-container { 
        flex-direction: column; 
        text-align: center; 
        margin-bottom: 10px; 
      }
      .logo { 
        margin-right: 0; 
        margin-bottom: 5px; 
        width: 50px; 
      }
      h2 { 
        font-size: 1.2em; 
      }
      .mission-statement { 
        font-size: 0.9em; 
        max-width: 90%; 
      }
      .mission-subtext { 
        font-size: 0.7em; 
        max-width: 90%; 
      }
      select, input { 
        width: 100%; 
        margin-bottom: 8px; 
        padding: 4px; 
      }
      .controls { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
      }
      .search-row { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 5px;
      }
      .content-count, .match-count { 
        text-align: center; 
      }
      .search-input-container { 
        width: 100%; 
      }
      #searchInput { 
        width: 100%; 
        max-width: 250px; 
      }
      .verse-item {
        padding: 10px;
      }
      .verse-header {
        font-size: 1.2em;
      }
      .verse-details strong {
        width: 150px;
      }
      .footer { 
        max-width: 90%; 
        margin: 5px auto 0;
      }
      .social-links, .contact-methods {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      .qr-code img {
        width: 120px;
        height: 120px;
      }
      .support-text p, .contact-text p {
        font-size: 0.9em;
      }
      .logos img { 
        width: 40px; 
        margin-right: 3px; 
      }
      .logos img:last-child { 
        margin-right: 0; 
      }
      .follow-text { 
        font-size: 0.9em; 
      }
      .contact-text { 
        font-size: 0.75em; 
      }
      .contact-text img { 
        width: 20px; 
      }
      .qr-code img { 
        width: 150px; 
      }
      .support-text { 
        font-size: 0.7em; 
      }
      .share-buttons img {
        width: 20px;
        height: 20px;
      }
    }
    .spinner {
      text-align: center;
      font-size: 1.2em;
      color: #0066cc;
    }
    .footer {
      background-color: #f5f5f5;
      padding: 25px 15px;
      border-top: 1px solid #ddd;
      margin-top: 30px;
      font-family: Arial, sans-serif;
      color: #333;
    }
    .support-section, .social-section, .contact-section {
      max-width: 800px;
      margin: 0 auto 25px;
      text-align: center;
    }
    .support-text p {
      margin: 8px 0;
      line-height: 1.5;
    }
    .donation-cta {
      font-weight: bold;
      color: #0066cc;
      margin-top: 15px !important;
    }
    .qr-code {
      margin: 15px auto;
      text-align: center;
    }
    .qr-code img {
      width: 150px;
      height: 150px;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: transform 0.3s;
    }
    .qr-code img:hover {
      transform: scale(1.05);
    }
    .qr-hint {
      display: block;
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .social-links, .contact-methods {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .social-links a, .contact-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background: #0066cc;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .social-links a:hover, .contact-btn:hover {
      background: #0055aa;
    }
    .social-links img, .contact-btn img {
      width: 20px;
      height: 20px;
    }
    .creator-name {
      font-weight: bold;
      margin-top: 10px;
      color: #0066cc;
    }
    .contact-text p {
      margin: 8px 0;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="header-info">
    <span class="last-updated" id="lastUpdated">Last updated: loading...</span>
    <span class="visitor-count" id="visitorCount">Visitors: Loading...</span>
  </div>
  <div class="header-container">
    <img src="images/sastik_logo.png" alt="SASTIK Logo" class="logo" onerror="this.style.display='none';console.log('SASTIK logo failed to load');">
    <h2><a href="https://www.facebook.com/sastikofficial/" target="_blank">SASTIK GBQ+</a></h2>
  </div>
  <div class="mission-statement">
    <b>‡¶∏‡ßÅ‡¶∏‡ßç‡¶• ‡¶Ü‡¶∏‡ßç‡¶§‡¶ø‡¶ï‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶ö‡¶æ‡¶∞‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá, ‡¶π‡¶ø‡¶Ç‡¶∏‡¶æ ‡¶ì ‡¶¨‡¶ø‡¶¶‡ßç‡¶¨‡ßá‡¶∑‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡ßá üö´ ‡¶∏‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡ßÄ‡¶§‡¶ø ‡¶ì ‡¶Æ‡¶æ‡¶®‡¶¨‡¶§‡¶æ‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‚úÖ</b><br>
    <b>To Propagate Sane Theism, Against Hatred and Violence üö´ In Favor of Harmony and Humanity ‚úÖ</b>
  </div>
  <div class="mission-subtext">
    ‚¨áÔ∏è A unified platform offering categorized and filtered theological verses based on modern-day relevance empowering you to wisely apply or disregard teachings and avoid the misguidance of charlatans. ‚¨áÔ∏è
  </div>
  <div class="controls" id="controls">
    <label for="sheetSelector">Select Gita/Bible/Quran+:</label>
    <select id="sheetSelector" onchange="loadSheetData()">
      <option value="">Select a sheet</option>
      <option value="gita">Gita</option>
      <option value="bible">Bible</option>
      <option value="quran">Quran</option>
      <option value="hadith">Hadith</option>
      <option value="miscellaneous">Miscellaneous</option>
    </select>
    <label for="categoryFilter">Filter by Sloka/Verse/Ayah Category:</label>
    <select id="categoryFilter" disabled onchange="filterTable()">
      <option value="">All</option>
      <option value="Universal or Ethical Verse">Universal or Ethical Verse</option>
      <option value="General Intra-community Verse">General Intra-community Verse</option>
      <option value="Controversial Intra-community Verse">Controversial Intra-community Verse</option>
      <option value="Divisive or Hateful Inter-community Verse">Divisive or Hateful Inter-community Verse</option>
      <option value="Violent or Aggressive Inter-community Verse">Violent or Aggressive Inter-community Verse</option>
    </select>
    <label for="subCategoryFilter">Filter by Sub Category:</label>
    <select id="subCategoryFilter" disabled onchange="filterTable()">
      <option value="">All</option>
      <option value="Historical or Narrative verse">Historical or Narrative verse</option>
      <option value="Discriminatory or Prejudiced Verse">Discriminatory or Prejudiced Verse</option>
      <option value="Metaphorical or Symbolic verse">Metaphorical or Symbolic verse</option>
    </select>
  </div>
  <div class="search-row" id="search-row">
    <div class="content-count" id="contentCount">Content Found: 0</div>
    <div class="search-input-container">
      <input type="text" id="searchInput" placeholder="Search in table..." disabled onkeyup="searchTable()">
    </div>
    <div class="match-count" id="matchCount">Matches found: 0</div>
  </div>
  <div class="verse-container" id="verseContainer"></div>
  <div class="footer">
    <div class="support-section">
      <div class="support-text">
        <p>Developing and maintaining this unified platform requires continuous effort and dedication.</p>
        <p>Your support helps sustain the SASTIK mission to create a harmonious society through interfaith understanding.</p>
        <p class="donation-cta">Please consider contributing via UPI to support this initiative:</p>
      </div>
      <div class="qr-code">
        <a href="upi://pay?pa=subhendu.srk1993-1@okicici&pn=Subhendu%20Ghosh&aid=uGICAgIDIy-m-Kw" target="_blank">
          <img src="images/qrcode_logo.jpg" alt="UPI QR Code for Donations" onerror="this.onerror=null;this.src='images/qr_placeholder.png'">
          <span class="qr-hint">(Tap/Click to donate)</span>
        </a>
      </div>
    </div>
    <div class="social-section">
      <div class="follow-text">For more interfaith insights, follow on:</div>
      <div class="social-links">
        <a href="https://www.facebook.com/SubhenduGhoshSastik/" target="_blank" aria-label="Facebook">
          <img src="images/facebook_logo.png" alt="Facebook" loading="lazy">
          <span>Facebook</span>
        </a>
        <a href="https://www.youtube.com/@SGSastik" target="_blank" aria-label="YouTube">
          <img src="images/youtube_logo.png" alt="YouTube" loading="lazy">
          <span>YouTube</span>
        </a>
        <a href="https://x.com/subhendug1793" target="_blank" aria-label="Twitter/X">
          <img src="images/x_logo.png" alt="X (Twitter)" loading="lazy">
          <span>Twitter/X</span>
        </a>
      </div>
      <div class="creator-name">Subhendu Ghosh Sastik</div>
    </div>
    <div class="contact-section">
      <div class="contact-text">
        <p>To contribute verse updates üìú or share suggestions/feedback üí≠</p>
        <p>Connect directly via:</p>
      </div>
      <div class="contact-methods">
        <a href="https://t.me/Sg1793" target="_blank" class="contact-btn">
          <img src="images/telegram_logo.png" alt="Telegram" loading="lazy">
          <span>Telegram</span>
        </a>
        <a href="mailto:sastikofficial@gmail.com" target="_blank" class="contact-btn">
          <img src="images/gmail_logo.png" alt="Email" loading="lazy">
          <span>sastikofficial@gmail.com</span>
        </a>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, increment, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCou0LOLpeijDPxHlVN1pvpruvxdrLKVWk",
    authDomain: "verseviewercounter.firebaseapp.com",
    projectId: "verseviewercounter",
    storageBucket: "verseviewercounter.firebasestorage.app",
    messagingSenderId: "486076065573",
    appId: "1:486076065573:web:363e819071b11880089ccc",
    measurementId: "G-NE4PCNMR8D"
  };

  let db = null;
  let data = [];
  let currentSheet = "";

  function initializeFirebase() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firebase initialized successfully at", new Date().toISOString());
    } catch (error) {
      console.error("Firebase initialization error:", error.message, "at", new Date().toISOString());
      displayError("Firebase initialization failed. Check console for details.");
    }
  }

  window.copyToClipboard = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Link copied to clipboard!");
    }).catch(err => {
      console.error("Failed to copy link:", err);
      alert("Failed to copy link. Please try again.");
    });
  };

  window.shareAnywhere = function(verseText, shareUrl) {
    if (navigator.share) {
      navigator.share({
        title: 'SASTIK GBQ+ Verse',
        text: verseText,
        url: shareUrl
      }).catch(err => console.error('Share error:', err));
    } else {
      alert('Share not supported on this browser. Copy the link instead.');
    }
  };

  function updateLastUpdated() {
    try {
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        let lastUpdated;
        if (document.lastModified && !isNaN(new Date(document.lastModified).getTime())) {
          const date = new Date(document.lastModified);
          const dateStr = date.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = date.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
        } else {
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = now.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
          console.warn("document.lastModified unavailable, using current date:", lastUpdated);
        }
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">${lastUpdated}</a>`;
      }
    } catch (error) {
      console.error("Error updating last modified:", error.message, "at", new Date().toISOString());
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">Unknown</a>`;
      }
    }
  }

  async function updateVisitorCount() {
    const visitorCount = document.getElementById("visitorCount");
    if (!visitorCount) return;
    visitorCount.innerHTML = "Visitors: Loading...";
    try {
      if (!db) throw new Error("Firestore not initialized");
      const counterRef = doc(db, "counters", "viewerCount");
      await setDoc(counterRef, { count: increment(1) }, { merge: true });
      const counterSnap = await getDoc(counterRef);
      if (counterSnap.exists()) {
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${counterSnap.data().count || 0}`;
      } else {
        throw new Error("Counter document does not exist");
      }
    } catch (error) {
      console.error("Firestore error:", error.message, "at", new Date().toISOString());
      try {
        const response = await fetch('counter.json', { cache: 'no-store' });
        if (!response.ok) throw new Error(`counter.json fetch error: ${response.status}`);
        const data = await response.json();
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${data.visitors || 0}`;
      } catch (jsonError) {
        console.error("Local counter fetch error:", jsonError.message, "at", new Date().toISOString());
        visitorCount.innerHTML = "Visitors: 1";
        visitorCount.classList.add("error");
      }
    }
  }

  async function loadSheetData() {
    try {
      const sheetSelector = document.getElementById("sheetSelector");
      currentSheet = sheetSelector.value;
      
      if (!currentSheet) {
        resetFilters();
        return;
      }

      setLoadingState(true);
      
      const urlsToTry = [
        `data/${currentSheet.toLowerCase()}.json`,
        `${currentSheet.toLowerCase()}.json`,
        `https://example.com/data/${currentSheet.toLowerCase()}.json`
      ];
      
      let response, sheetData;
      for (const url of urlsToTry) {
        try {
          response = await fetch(url, { cache: 'no-store' });
          if (response.ok) {
            sheetData = await response.json();
            if (Array.isArray(sheetData) && sheetData.length > 0) {
              break;
            }
          }
        } catch (err) {
          console.error(`Error loading ${url}:`, err);
        }
      }

      if (!sheetData || !Array.isArray(sheetData)) {
        throw new Error("Failed to load valid data from all sources");
      }

      data = sheetData;
      enableFilters();
      updateVerseDisplay(data);
    } catch (error) {
      console.error("Error in loadSheetData:", error);
      showErrorToUser("Failed to load data. Please try again later.");
      resetFilters();
    } finally {
      setLoadingState(false);
    }
  }

  function searchTable() {
    try {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
      
      if (!searchTerm) {
        filterTable();
        return;
      }

      const filteredRows = getFilteredRows();
      
      const searchResults = filteredRows.map(row => {
        const highlightedRow = {...row};
        let matchCount = 0;
        
        Object.keys(highlightedRow).forEach(key => {
          const value = highlightedRow[key];
          if (typeof value === "string") {
            const highlighted = value.replace(
              new RegExp(escapeRegExp(searchTerm), 'gi'),
              match => {
                matchCount++;
                return `<mark>${match}</mark>`;
              }
            );
            highlightedRow[key] = highlighted;
          } else if (value && typeof value === "object" && value.text) {
            const highlighted = value.text.replace(
              new RegExp(escapeRegExp(searchTerm), 'gi'),
              match => {
                matchCount++;
                return `<mark>${match}</mark>`;
              }
            );
            highlightedRow[key] = {...value, text: highlighted};
          }
        });
        
        return {row: highlightedRow, matchCount};
      }).filter(result => result.matchCount > 0);

      updateVerseDisplay(searchResults.map(r => r.row));
      updateMatchCount(searchResults.reduce((sum, r) => sum + r.matchCount, 0));
    } catch (error) {
      console.error("Error in searchTable:", error);
    }
  }

  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function setLoadingState(isLoading) {
    const verseContainer = document.getElementById("verseContainer");
    if (isLoading) {
      verseContainer.innerHTML = "<div class='spinner'>Loading...</div>";
    } else if (verseContainer.innerHTML === "<div class='spinner'>Loading...</div>") {
      verseContainer.innerHTML = "";
    }
  }

  function enableFilters() {
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    categoryFilter.disabled = false;
    subCategoryFilter.disabled = false;
    searchInput.disabled = false;
    document.querySelector('.search-row').style.display = 'flex';
  }

  function resetFilters() {
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    categoryFilter.disabled = true;
    subCategoryFilter.disabled = true;
    searchInput.disabled = true;
    document.getElementById("verseContainer").innerHTML = "";
    document.querySelector('.search-row').style.display = 'flex';
    updateContentCount(0);
    updateMatchCount(0);
  }

  function showErrorToUser(message) {
    const errorDisplay = document.getElementById("errorDisplay") || document.createElement("div");
    errorDisplay.id = "errorDisplay";
    errorDisplay.style.color = "red";
    errorDisplay.style.textAlign = "center";
    errorDisplay.style.marginBottom = "10px";
    errorDisplay.textContent = message;
    document.querySelector(".controls").after(errorDisplay);
  }

  function getFilteredRows() {
    const category = document.getElementById("categoryFilter").value;
    const subCategory = document.getElementById("subCategoryFilter").value;
    return data.filter(row => {
      const categoryMatch = !category || (row["Verse Category "] && typeof row["Verse Category "] === "string" && 
                                        row["Verse Category "].trim().toLowerCase() === category.toLowerCase());
      const subCategoryMatch = !subCategory || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                              row["Sub Category"].trim().toLowerCase() === subCategory.toLowerCase());
      return categoryMatch && subCategoryMatch;
    });
  }

  function updateVerseDisplay(rows) {
    const verseContainer = document.getElementById("verseContainer");
    verseContainer.innerHTML = "";
    if (!rows || rows.length === 0) {
      verseContainer.innerHTML = "<div style='text-align: center; color: red;'>No data available or error loading data</div>";
      console.error("No rows to display:", rows, "at", new Date().toISOString());
      return;
    }
    rows.forEach((row, index) => {
      let item = document.createElement("div");
      item.className = "verse-item";
      
      let detailsHtml = `<div class="verse-header">${row["Verse Name"]?.text || row["Verse Name"] || "Unnamed Verse"}</div>`;
      detailsHtml += `<div class="verse-details">`;
      let categoryClass = "";
      if (row["Verse Category "]) {
        categoryClass = getCategoryClass(row["Verse Category "].trim().toLowerCase());
        detailsHtml += `<div class="${categoryClass}"><strong>Verse Category:</strong> ${row["Verse Category "] || "-"}</div>`;
      }
      const headers = {
        "gita": ["Sub Category", "Bengali Translation", "Verse Transliteration (B/E)", "English Translation", "Sanskrit Transliteration", "Reference Links and Files", "SGS Remarks"],
        "bible": ["Sub Category", "Bengali Translation", "Verse in English", "Reference Links and Files", "SGS Remarks"],
        "quran": ["Sub Category", "Bengali Meaning", "Verse Transliteration (B/E)", "English Meaning", "Reference Links and Files", "SGS Remarks"]
      }[currentSheet] || ["Sub Category", "Bengali Translation", "English Translation", "Reference Links and Files", "SGS Remarks"];

      headers.forEach(header => {
        let content = row[header] || "-";
        let displayContent;
        if (typeof content === "string" || (typeof content === "object" && content && content.text)) {
          const textToSearch = typeof content === "object" ? content.text : content;
          displayContent = typeof content === "object" && content.url
            ? `<a href="${content.url}" target="_blank">${textToSearch}</a>`
            : content;
        } else if (typeof content === "object" && content && !content.text) {
          displayContent = "-";
        } else {
          displayContent = content.toString();
        }
        detailsHtml += `<div><strong>${header.replace("Verse in English", "English Translation").replace("Bengali Meaning", "Bengali Translation")}:</strong> ${displayContent}</div>`;
      });
      detailsHtml += `</div>`;
      let shareHtml = addShareButton(row, index, true);
      let seeFullVerseHtml = `<a href="#" class="see-full-verse" onclick="viewFullVerse(${index}); return false;">See Full Verse</a>`;

      item.innerHTML = detailsHtml + `<div class="share-buttons">${shareHtml}</div>` + seeFullVerseHtml;
      verseContainer.appendChild(item);
    });
    updateContentCount(rows.length);
  }

  function viewFullVerse(index) {
    const row = data[index];
    if (row) {
      let fullDetails = `<div class="verse-item">`;
      fullDetails += `<div class="verse-header">${row["Verse Name"]?.text || row["Verse Name"] || "Unnamed Verse"}</div>`;
      fullDetails += `<div class="verse-details">`;
      let categoryClass = "";
      if (row["Verse Category "]) {
        categoryClass = getCategoryClass(row["Verse Category "].trim().toLowerCase());
        fullDetails += `<div class="${categoryClass}"><strong>Verse Category:</strong> ${row["Verse Category "] || "-"}</div>`;
      }
      const allHeaders = ["Verse Category ", "Sub Category", "Bengali Translation", "Verse Transliteration (B/E)", "English Translation", "Verse in English", "Sanskrit Transliteration", "Bengali Meaning", "English Meaning", "Reference Links and Files", "SGS Remarks"];
      allHeaders.forEach(header => {
        if (row[header] !== undefined) {
          let content = row[header] || "-";
          let displayContent;
          if (typeof content === "string" || (typeof content === "object" && content && content.text)) {
            const textToSearch = typeof content === "object" ? content.text : content;
            displayContent = typeof content === "object" && content.url
              ? `<a href="${content.url}" target="_blank">${textToSearch}</a>`
              : content;
          } else if (typeof content === "object" && content && !content.text) {
            displayContent = "-";
          } else {
            displayContent = content.toString();
          }
          fullDetails += `<div><strong>${header.replace("Verse in English", "English Translation").replace("Bengali Meaning", "Bengali Translation")}:</strong> ${displayContent}</div>`;
        }
      });
      fullDetails += `</div>`;
      let shareHtml = addShareButton(row, index, true);
      fullDetails += `<div class="share-buttons">${shareHtml}</div>`;
      fullDetails += `<a href="#" class="see-full-verse" onclick="hideFullVerse(); return false;">Hide Full Verse</a>`;
      fullDetails += `</div>`;
      const verseContainer = document.getElementById("verseContainer");
      verseContainer.innerHTML = fullDetails;
    }
  }

  function hideFullVerse() {
    updateVerseDisplay(data);
  }

  function getCategoryClass(category) {
    switch (category?.toLowerCase()) {
      case "universal or ethical verse": return "category-universal";
      case "general intra-community verse": return "category-general";
      case "controversial intra-community verse": return "category-controversial";
      case "divisive or hateful inter-community verse": return "category-divisive";
      case "violent or aggressive inter-community verse": return "category-violent";
      default: return "";
    }
  }

  function addShareButton(row, index, isTableView = true) {
    const verseText = (row["Bengali Translation"]?.text || row["Bengali Meaning"]?.text || row["Bengali Translation"] || row["Bengali Meaning"] || "") +
                     (row["English Translation"]?.text || row["Verse in English"]?.text || row["English Meaning"]?.text || row["English Translation"] || row["Verse in English"] || row["English Meaning"] || "");
    let verseName = row["Verse Name"]?.text || row["Verse Name"] || index.toString();
    if (typeof verseName !== "string") {
      verseName = index.toString();
      console.warn(`Invalid Verse Name for sheet=${currentSheet}, index=${index}:`, verseName, "at", new Date().toISOString());
    }
    verseName = verseName.trim();
    const shareUrl = `https://subhendug1793.github.io/verse-viewer/?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseName)}`;
    const escapedShareUrl = shareUrl.replace(/'/g, "\\'");
    let html = '';
    if (isTableView) {
      html += `<a href="${shareUrl}" target="_blank"><img src="images/click_logo.png" alt="View" onerror="this.src='https://via.placeholder.com/24?text=üëÅ';"></a>`;
    }
    const copyLink = document.createElement("a");
    copyLink.href = "#";
    copyLink.addEventListener("click", (e) => {
      e.preventDefault();
      copyToClipboard(escapedShareUrl);
    });
    copyLink.innerHTML = `<img src="images/link_logo.png" alt="Copy Link" onerror="this.src='https://via.placeholder.com/24?text=üîó';">`;
    const shareLink = document.createElement("a");
    shareLink.href = "#";
    shareLink.addEventListener("click", (e) => {
      e.preventDefault();
      shareAnywhere(verseText.replace(/'/g, "\\'"), escapedShareUrl);
    });
    shareLink.innerHTML = `<img src="images/share_logo.png" alt="Share" onerror="this.src='https://via.placeholder.com/24?text=üì§';">`;
    html += `
      <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(verseText + ' ' + shareUrl)}" target="_blank"><img src="images/whatsapp_logo.png" alt="WhatsApp"></a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&display=popup" target="_blank"><img src="images/facebook_logo.png" alt="Facebook"></a>
      <a href="https://x.com/intent/tweet?text=${encodeURIComponent(verseText)}&url=${encodeURIComponent(shareUrl)}" target="_blank"><img src="images/x_logo.png" alt="X"></a>
    `;
    return html;
  }

  function filterTable() {
    const category = document.getElementById("categoryFilter").value;
    const subCategory = document.getElementById("subCategoryFilter").value;
    const searchInput = document.getElementById("searchInput");
    const searchTerm = searchInput.value.toLowerCase().trim();

    if (currentSheet && data.length > 0) {
      let filteredRows = data.filter(row => {
        const categoryMatch = !category || (row["Verse Category "] && typeof row["Verse Category "] === "string" && 
                                          row["Verse Category "].trim().toLowerCase() === category.toLowerCase());
        const subCategoryMatch = !subCategory || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                                row["Sub Category"].trim().toLowerCase() === subCategory.toLowerCase());
        return categoryMatch && subCategoryMatch;
      });
      updateVerseDisplay(filteredRows);
      if (searchTerm) {
        searchTable();
      } else {
        updateMatchCount(0);
      }
    }
  }

  function updateContentCount(count) {
    document.getElementById("contentCount").textContent = `Content Found: ${count}`;
  }

  function updateMatchCount(count) {
    document.getElementById("matchCount").textContent = `Matches found: ${count}`;
  }

  window.loadSheetData = loadSheetData;
  window.filterTable = filterTable;
  window.searchTable = searchTable;
  window.viewFullVerse = viewFullVerse;
  window.hideFullVerse = hideFullVerse;

  window.onload = () => {
    console.log("Window loaded at", new Date().toISOString());
    initializeFirebase();
    updateLastUpdated();
    updateVisitorCount();

    const lastSheet = localStorage.getItem("lastSheet") || "gita";
    const sheetSelector = document.getElementById("sheetSelector");
    sheetSelector.value = lastSheet;
    loadSheetData();
  };
</script>
</body>
</html>
