<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASTIK GBQ+ Verse Filter</title>
  <meta property="og:title" content="SASTIK GBQ+ Verse">
  <meta property="og:description" content="Explore categorized theological verses from the Gita, Bible, Quran, and more.">
  <meta property="og:image" content="https://subhendug1793.github.io/verse-viewer/images/sastik_logo.png">
  <meta property="og:url" content="https://subhendug1793.github.io/verse-viewer/">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f9f9f9; 
      position: relative; 
      min-height: 100vh; 
      display: flex;
      flex-direction: column;
    }
    .header-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .header-info { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      font-size: 0.9em; 
      color: #666; 
      z-index: 10; 
    }
    .header-info .last-updated a {
      color: #0066cc;
      text-decoration: none;
    }
    .header-info .visitor-count {
      margin-left: 20px;
      vertical-align: middle;
      display: inline-block;
      min-height: 20px; 
      font-weight: bold;
      color: #333;
      z-index: 10;
    }
    .header-info .visitor-count.error {
      font-weight: normal;
      color: #999;
    }
    .logo { 
      width: 80px; 
      height: auto; 
      margin-right: 10px; 
    }
    h2 { 
      color: #0066cc;
      text-align: center; 
      margin: 0; 
      font-size: 1.8em;
      font-weight: bold; 
      white-space: nowrap; 
      text-decoration: none; 
    }
    h2 a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    h2 a:hover { 
      text-decoration: underline; 
    }
    .mission-statement { 
      text-align: center; 
      margin: 0 auto 10px;
      max-width: 80%; 
      font-size: 1.1em; 
      line-height: 1.5; 
      font-weight: bold; 
    }
    .mission-subtext { 
      text-align: center; 
      margin: 0 auto 20px; 
      max-width: 80%; 
      font-size: 0.8em;
      line-height: 1.2; 
      font-weight: normal; 
    }
    .controls { 
      margin-bottom: 10px; 
      text-align: center; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 2px; 
      flex-wrap: wrap; 
    }
    .search-row { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 5px;
    }
    .content-count, .match-count { 
      font-size: 1em; 
      color: #333; 
      text-align: left; 
    }
    .search-input-container {
      flex-grow: 0;
      text-align: center;
    }
    select, input { 
      padding: 5px; 
      margin-right: 10px; 
    }
    select:disabled, input:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }
    #searchInput { 
      width: 200px; 
    }
    table { 
      border-collapse: collapse; 
      width: 80%; 
      margin: 0 auto 5px;
      background-color: #fff; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      position: relative; 
      z-index: 1; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center; 
    }
    td a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    td a:hover { 
      text-decoration: underline; 
    }
    td.category-universal { 
      background-color: #00FF00; 
    }
    td.category-general { 
      background-color: #00FFFF; 
    }
    td.category-controversial { 
      background-color: #FFFF00; 
    }
    td.category-divisive { 
      background-color: #FF0000; 
    }
    td.category-violent { 
      background-color: #000000; 
      color: #FFFFFF; 
    }
    th.gita-header, th.bible-header, th.quran-header, th.hadith-header, th.miscellaneous-header { 
      background-color: white; 
      color: black; 
    }
    mark { 
      background-color: yellow; 
      font-weight: bold; 
    }
    .footer { 
      position: relative; 
      margin-top: auto; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      max-width: 80%; 
      margin: 5px auto 0;
      padding: 10px 0; 
      pointer-events: auto; 
    }
    .footer a { 
      text-decoration: none; 
      cursor: pointer; 
      pointer-events: auto; 
    }
    .footer img { 
      vertical-align: middle; 
      pointer-events: auto; 
    }
    .logos { 
      display: flex; 
      align-items: center; 
      margin-bottom: 5px; 
    }
    .logos img { 
      width: 60px; 
      height: auto; 
      margin-right: 5px; 
    }
    .logos img:last-child { 
      margin-right: 0; 
    }
    .text-group { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      text-align: center; 
    }
    .support-text { 
      font-weight: bold; 
      font-size: 0.9em; 
      margin-bottom: 10px; 
    }
    .support-text span { 
      display: block; 
    }
    .follow-text { 
      font-size: 1.1em; 
      margin: 2px 0; 
    }
    .name-text { 
      font-size: 2em; 
      margin: 5px 0; 
    }
    .contact-text { 
      font-size: 1em; 
      max-width: 90%; 
      text-align: center; 
      pointer-events: auto; 
    }
    .contact-text span { 
      display: block; 
      white-space: nowrap; 
      line-height: 1.4; 
    }
    .contact-text img { 
      width: 20px; 
      height: auto; 
      vertical-align: middle; 
    }
    .qr-code { 
      margin: 10px 0; 
    }
    .qr-code img { 
      width: 200px; 
      height: auto; 
    }
    .single-verse-view { 
      text-align: center; 
      margin: 20px auto; 
      max-width: 80%; 
      padding: 20px; 
      background-color: #fff; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      position: relative; 
    }
    .single-verse-view h3 { 
      color: #0066cc; 
      margin-bottom: 10px; 
    }
    .verse-details { 
      margin-bottom: 20px; 
      text-align: left; 
    }
    .verse-details p { 
      margin: 5px 0; 
      font-size: 1em; 
    }
    .verse-details strong { 
      display: inline-block; 
      width: 150px; 
      font-weight: bold; 
    }
    .share-buttons { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 8px; 
    }
    .single-verse-share-buttons { 
      display: flex; 
      flex-direction: row; 
      justify-content: center; 
      gap: 12px; 
      flex-wrap: wrap; 
    }
    .share-buttons img, .single-verse-share-buttons img { 
      width: 24px; 
      height: 24px; 
      vertical-align: middle; 
    }
    .share-buttons a, .single-verse-share-buttons a { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      width: 40px; 
      position: relative; 
    }
    .share-buttons a.view-link::after { 
      content: none; /* Removed 👆 emoji */
    }
    .navigation-arrows {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
    }
    .navigation-arrows a {
      text-decoration: none;
      pointer-events: auto;
    }
    .navigation-arrows img {
      width: 40px;
      height: auto;
    }
    .navigation-arrows a.disabled img {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .navigation-arrows .prev {
      position: absolute;
      left: -40px; /* Moved left to avoid text overlap */
    }
    .navigation-arrows .next {
      position: absolute;
      right: -30px;
    }
    .reaction-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .reaction-buttons button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 18px;
    }
    .reaction-buttons button.active {
      font-weight: bold;
    }
    .reaction-buttons span {
      font-size: 0.9em;
      color: #333;
    }
    @media (max-width: 600px) {
      .header-info { 
        position: relative; 
        top: 0; 
        right: 0; 
        text-align: center; 
        margin: 10px 0; 
        font-size: 0.8em; 
      }
      .header-container { 
        flex-direction: column; 
        text-align: center; 
        margin-bottom: 10px; 
      }
      .logo { 
        margin-right: 0; 
        margin-bottom: 5px; 
        width: 50px; 
      }
      h2 { 
        font-size: 1.2em; 
      }
      .mission-statement { 
        font-size: 0.9em; 
        max-width: 90%; 
      }
      .mission-subtext { 
        font-size: 0.7em; 
        max-width: 90%; 
      }
      select, input { 
        width: 100%; 
        margin-bottom: 8px; 
        padding: 4px; 
      }
      .controls { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
      }
      .search-row { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 5px;
      }
      .content-count, .match-count { 
        text-align: center; 
      }
      .search-input-container { 
        width: 100%; 
      }
      #searchInput { 
        width: 100%; 
        max-width: 250px; 
      }
      table { 
        width: 100%; 
        font-size: 0.9em; 
        margin-bottom: 5px;
      }
      th, td { 
        padding: 6px; 
      }
      .footer { 
        max-width: 90%; 
        margin: 5px 0 0;
      }
      .logos img { 
        width: 40px; 
        margin-right: 3px; 
      }
      .logos img:last-child { 
        margin-right: 0; 
      }
      .follow-text { 
        font-size: 0.9em; 
      }
      .contact-text { 
        font-size: 0.75em; 
      }
      .contact-text img { 
        width: 20px; 
      }
      .qr-code img { 
        width: 150px; 
      }
      .support-text { 
        font-size: 0.7em; 
      }
      .single-verse-view { 
        max-width: 90%; 
        padding: 15px; 
      }
      .verse-details p { 
        font-size: 0.9em; 
      }
      .verse-details strong { 
        width: 120px; 
      }
      .share-buttons img, .single-verse-share-buttons img { 
        width: 20px; 
        height: 20px; 
      }
      .share-buttons a, .single-verse-share-buttons a { 
        width: 30px; 
      }
      .navigation-arrows img {
        width: 30px;
      }
      .navigation-arrows .prev {
        left: -30px; /* Adjusted for mobile */
      }
      .navigation-arrows .next {
        right: -20px;
      }
      .reaction-buttons {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header-info">
    <span class="last-updated" id="lastUpdated">Last updated: loading...</span>
    <span class="visitor-count" id="visitorCount">Visitors: Loading...</span>
  </div>
  <div class="header-container">
    <img src="images/sastik_logo.png" alt="SASTIK Logo" class="logo" onerror="this.style.display='none';console.log('SASTIK logo failed to load');">
    <h2><a href="https://www.facebook.com/sastikofficial/" target="_blank">SASTIK GBQ+</a></h2>
  </div>
  <div class="mission-statement">
    <b>সুস্থ আস্তিকতা প্রচারের উদ্দেশ্যে, হিংসা ও বিদ্বেষের বিরুদ্ধে 🚫 সম্প্রীতি ও মানবতার পক্ষে ✅</b><br>
    <b>To Propagate Sane Theism, Against Hatred and Violence 🚫 In Favor of Harmony and Humanity ✅</b>
  </div>
  <div class="mission-subtext">
    ⬇️ A unified platform offering categorized and filtered theological verses based on modern-day relevance empowering you to wisely apply or disregard teachings and avoid the misguidance of charlatans. ⬇️
  </div>
  <div class="single-verse-view" id="singleVerseView" style="display: none;"></div>
  <div class="controls" id="controls">
    <label for="sheetSelector">Select Gita/Bible/Quran+:</label>
    <select id="sheetSelector" onchange="loadSheetData()">
      <option value="">Select a sheet</option>
      <option value="gita">Gita</option>
      <option value="bible">Bible</option>
      <option value="quran">Quran</option>
      <option value="hadith">Hadith</option>
      <option value="miscellaneous">Miscellaneous</option>
    </select>
    <label for="categoryFilter">Category:</label>
    <select id="categoryFilter" disabled onchange="filterTableData()">
      <option value="">All</option>
      <option value="Universal or Ethical Verse">Universal or Ethical Verse</option>
      <option value="General Intra-community Verse">General Intra-community Verse</option>
      <option value="Controversial Intra-community Verse">Controversial Intra-community Verse</option>
      <option value="Divisive or Hateful Inter-community Verse">Divisive or Hateful Inter-community Verse</option>
      <option value="Violent or Aggressive Inter-community Verse">Violent or Aggressive Inter-community Verse</option>
    </select>
    <label for="subCategoryFilter">Sub Category:</label>
    <select id="subCategoryFilter" disabled onchange="filterTableData()">
      <option value="">All</option>
      <option value="Historical or Narrative verse">Logical or Historical</option>
      <option value="Discriminatory or Prejudiced Verse">Prejudiced or Outdated</option>
      <option value="Metaphorical or Symbolic verse">Metaphorical or Symbolic</option>
    </select>
  </div>
  <div class="search-row" id="search-row">
    <div class="content-count" id="contentCount">Content Found: 0</div>
    <div class="search-input-container">
      <input type="text" id="searchInput" placeholder="Search verses..." disabled oninput="searchTableData()">
    </div>
    <div class="match-count" id="matchCount">Matches found: 0</div>
  </div>
  <table id="verseTable">
    <thead id="tableHeaders"></thead>
    <tbody id="verseBody"></tbody>
  </table>
  <div class="footer">
    <div class="text-group">
      <div class="support-text">
        <span>Developing and maintaining this unified platform requires continuous effort and dedication.</span>
        <span>We need your support to continue the SASTIK mission, which aims to create a better, harmonious society.</span>
        <span>You can contribute by scanning the <a href="upi://pay?pa=subhendu.srk1993-1@okicdialogue&pn=Subhendu%20Ghosh&aid=uGICAgIDIyfg-Kw" target="_blank" style="color: #0066cc; text-decoration: none;">UPI QR code</a> below 🙏</span>
      </div>
      <div class="qr-code">
        <a href="upi://pay?pa=subhendu.srk1993-1@okicdialogue&pn=Subhendu%20Ghosh&aid=uGICAgIDIyfg-Kw" target="_blank"><img src="images/qrcode_logo.jpg" alt="UPI QR Code" onerror="console.log('UPI QR code failed to load')"></a>
      </div>
      <div class="follow-text">For more insights, follow me on 👇</div>
      <div class="logos">
        <a href="https://www.facebook.com/SubhenduGhoshSastik/" target="_blank"><img src="images/facebook_logo.png" alt="Facebook" onload="console.log('Facebook logo loaded')" onerror="console.log('Facebook logo failed to load')"></a>
        <a href="https://www.youtube.com/@SGSastik" target="_blank"><img src="images/youtube_logo.png" alt="YouTube" onload="console.log('YouTube logo loaded')" onerror="console.log('YouTube logo failed to load')"></a>
        <a href="https://x.com/subhendug1793" target="_blank"><img src="images/x_logo.png" alt="X" onload="console.log('X logo loaded')" onerror="console.log('X logo failed to load')"></a>
      </div>
      <div class="name-text">Subhendu Ghosh Sastik</div>
      <div class="contact-text">
        <span>Contribute to verse updates 📜 or share suggestions 💭</span>
        <span>Connect on <a href="https://m.me/subhendu.ghosh.790349" target="_blank" style="color: #0066cc; text-decoration: none;">Messenger</a>, <a href="https://t.me/Sg1793" target="_blank"><img src="images/telegram_logo.png" alt="Telegram"></a>, or email <a href="mailto:sastikofficial@gmail.com" style="color: #0066cc; text-decoration: none;"><img src="images/gmail_logo.png" alt="Mail" onerror="console.log('Gmail logo failed to load')"></a> <a href="mailto:sastikofficial@gmail.com" style="color: #0066cc; text-decoration: none;">sastikofficial@gmail.com</a></span>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, increment, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCou0LOLpeijDPxHlVN1pvpruvxdrLKVWk",
    authDomain: "verseviewercounter.firebaseapp.com",
    projectId: "verseviewercounter",
    storageBucket: "verseviewercounter.firebasestorage.app",
    messagingSenderId: "486076065573",
    appId: "1:486076065573:web:363e819071b11880089ccc",
    measurementId: "G-NE4PCNMR8D"
  };

  let db = null;
  function initializeFirebase() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }
  }

  window.copyToClipboard = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Link copied to clipboard!");
    }).catch(err => {
      console.error("Failed to copy link:", err);
      alert("Failed to copy link. Please try again.");
    });
  };

  window.shareAnywhere = function(verseText, shareUrl) {
    if (navigator.share) {
      navigator.share({
        title: 'SASTIK GBQ+ Verse',
        text: verseText,
        url: shareUrl
      }).catch(err => console.error('Share error:', err));
    } else {
      alert('Share not supported on this browser. Copy the link instead.');
    }
  };

  let data = [];
  let currentSheet = "";
  let currentVerseIndex = -1;

  function updateLastUpdated() {
    try {
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        let lastUpdated;
        if (document.lastModified && !isNaN(new Date(document.lastModified).getTime())) {
          const date = new Date(document.lastModified);
          const dateStr = date.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = date.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
        } else {
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = now.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
          console.warn("document.lastModified unavailable, using current date:", lastUpdated);
        }
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">${lastUpdated}</a>`;
      }
    } catch (error) {
      console.error("Error updating last modified:", error);
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">Unknown</a>`;
      }
    }
  }

  async function updateVisitorCount() {
    const visitorCount = document.getElementById("visitorCount");
    if (!visitorCount) return;
    visitorCount.innerHTML = "Visitors: Loading...";
    try {
      if (!db) throw new Error("Firestore not initialized");
      const counterRef = doc(db, "counters", "viewerCount");
      await setDoc(counterRef, { count: increment(1) }, { merge: true });
      const counterSnap = await getDoc(counterRef);
      if (counterSnap.exists()) {
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${counterSnap.data().count || 0}`;
      } else {
        throw new Error("Counter document does not exist");
      }
    } catch (error) {
      console.error("Firestore error:", error);
      try {
        const response = await fetch('counter.json', { cache: 'no-store' });
        if (!response.ok) throw new Error(`counter.json fetch error: ${response.status}`);
        const data = await response.json();
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${data.visitors}`;
      } catch (jsonError) {
        console.error("Local counter fetch error:", jsonError);
        visitorCount.innerHTML = "Visitors: Unknown";
        visitorCount.classList.add("error");
      }
    }
  }

  async function loadSheetData() {
    const sheetSelector = document.getElementById("sheetSelector");
    currentSheet = sheetSelector.value;
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    let errorDisplay = document.getElementById("errorDisplay");
    if (!errorDisplay) {
      errorDisplay = document.createElement("div");
      errorDisplay.id = "errorDisplay";
      errorDisplay.style.color = "red";
      errorDisplay.style.textAlign = "center";
      errorDisplay.style.marginBottom = "10px";
      document.querySelector(".controls").after(errorDisplay);
    }

    if (currentSheet) {
      categoryFilter.disabled = false;
      subCategoryFilter.disabled = false;
      searchInput.disabled = false;
      errorDisplay.textContent = "";
      document.querySelector('.search-row').style.display = 'flex';
      const urlsToTry = [
        `${currentSheet}.json`,
        `${currentSheet.toLowerCase()}.json`,
        `${currentSheet.charAt(0).toUpperCase() + currentSheet.slice(1).toLowerCase()}.json`
      ];
      let response, sheetData;
      for (const url of urlsToTry) {
        try {
          console.log(`Attempting to fetch: ${url}`);
          response = await fetch(url, { cache: 'no-store' });
          console.log(`Fetch response for ${url}: ${response.status} ${response.statusText}`);
          if (response.ok) {
            sheetData = await response.json();
            console.log(`Successfully loaded ${url}`);
            break;
          } else {
            console.warn(`Fetch failed for ${url}: ${response.status} ${response.statusText}`);
          }
        } catch (err) {
          console.error(`Error fetching ${url}:`, err.message);
        }
      }
      if (sheetData) {
        data = sheetData;
        updateTableHeaders(currentSheet);
        updateTableData(data);
        updateContentCountDisplay(data.length);
        updateMatchCountDisplay(0);
      } else {
        errorDisplay.textContent = `Error loading ${currentSheet}.json. Please check if the file exists or contact support.`;
        document.getElementById("verseBody").innerHTML = `<tr><td colspan="5" style="text-align: center;">Error loading ${currentSheet}.json: File not found or inaccessible</td></tr>`;
        updateContentCountDisplay(0);
        updateMatchCountDisplay(0);
      }
    } else {
      categoryFilter.disabled = true;
      subCategoryFilter.disabled = true;
      searchInput.disabled = true;
      errorDisplay.textContent = "";
      document.getElementById("verseBody").innerHTML = `<tr><td colspan="5" style="text-align: center;">Please select a sheet to view verses.</td></tr>`;
      document.getElementById("tableHeaders").innerHTML = "";
      document.querySelector('.search-row').style.display = 'flex';
      updateContentCountDisplay(0);
      updateMatchCountDisplay(0);
    }
  }

  async function loadSingleVerse() {
    const params = new URLSearchParams(window.location.search);
    const sheet = params.get("sheet");
    const verseParam = params.get("verse");
    let verseIndex = -1;

    if (sheet && verseParam) {
      currentSheet = sheet;
      const urlsToTry = [
        `${sheet}.json`,
        `${sheet.toLowerCase()}.json`,
        `${sheet.charAt(0).toUpperCase() + sheet.slice(1).toLowerCase()}.json`
      ];
      let response, sheetData;
      for (const url of urlsToTry) {
        try {
          console.log(`Attempting to fetch: ${url}`);
          response = await fetch(url, { cache: 'no-store' });
          console.log(`Fetch response for ${url}: ${response.status} ${response.statusText}`);
          if (response.ok) {
            sheetData = await response.json();
            console.log(`Successfully loaded ${url}`);
            break;
          } else {
            console.warn(`Fetch failed for ${url}: ${response.status} ${response.statusText}`);
          }
        } catch (err) {
          console.error(`Error fetching ${url}:`, err.message);
        }
      }
      if (sheetData) {
        data = sheetData;
        const normalizedVerseParam = decodeURIComponent(verseParam).trim();
        verseIndex = data.findIndex(row => {
          const verseName = (row["Verse Name"] || row["Verse"] || "").trim();
          return verseName === normalizedVerseParam;
        });
        if (verseIndex === -1) {
          verseIndex = parseInt(verseParam, 10);
        }
        if (!isNaN(verseIndex) && verseIndex >= 0 && verseIndex < data.length) {
          currentVerseIndex = verseIndex;
          const verse = data[verseIndex];
          displaySingleVerse(verse, { index: verseIndex });
          document.getElementById("controls").style.display = "none";
          document.getElementById("verseTable").style.display = "none";
          document.querySelector('.search-row').style.display = 'none';
          await fetchReactions(sheet, verseIndex);
        } else {
          console.error(`Verse not found: sheet=${sheet}, verse=${verseParam}, index=${verseIndex}`);
          displaySingleVerseData(null, null);
          document.getElementById("controls").style.display = "none";
          document.getElementById("verseTable").style.display = "none";
          document.querySelector('.search-row').style.display = 'none';
        }
      } else {
        console.error(`Failed to load ${sheet}.json`);
        displaySingleVerseData(null, null);
        document.getElementById("controls").style.display = "none";
        document.getElementById("verseTable").style.display = "none";
        document.querySelector('.search-row').style.display = 'none';
      }
    } else {
      document.getElementById("singleVerseView").style.display = 'none';
      document.querySelector('.search-row').style.display = 'flex';
    }
  }

  function displaySingleVerse(verse, row) {
    const singleVerseElement = document.getElementById("singleVerseView");
    if (!verse) {
      singleVerseElement.innerHTML = `<h3>Error</h3><p>Verse not found.</p>`;
      singleVerseElement.style.display = "block";
      return;
    }
    displaySingleVerseRow(verse, row);
  }

  function displaySingleVerseData(verse, row) {
    const singleVerseElement = document.getElementById("singleVerseView");
    if (!verse) {
      singleVerseElement.innerHTML = `<h3>Error</h3><p>Verse not found.</p>`;
      singleVerseElement.style.display = "block";
    } else {
      displaySingleVerseRow(verse, row);
    }
  }

  function displaySingleVerseRow(verse, row) {
    const singleVerseElement = document.getElementById("singleVerseView");
    if (!verse) {
      singleVerseElement.innerHTML = `<h3>Error</h3><p>Verse not found.</p>`;
      singleVerseElement.style.display = "block";
      return;
    }
    const verseRowName = verse["Verse Name"] || verse["Verse"] || "Verse";
    const headingElement = `${currentSheet.charAt(0).toUpperCase()}${currentSheet.slice(1)} ${verseRowName}`;
    let htmlContent = `<h3>${headingElement}</h3><div class="verse-details">`;
    const headersList = Object.keys(verse).filter(h => h !== "sheet");
    headersList.forEach(header => {
      let content = verse[header] || "-";
      if (typeof content === "object" && content.text && content.url) {
        content = `<a href="${content.url}" target="_blank">${content.text}</a>`;
      }
      const className = header === "Verse Category" && typeof verse[header] === "string" 
        ? getCategoryClassName(verse[header].trim().toLowerCase()) 
        : "";
      htmlContent += `<p${className ? ` class="${className}"` : ""}><strong>${header}:</strong> ${content}</p>`;
    });
    htmlContent += `<div class="navigation-arrows">
      <a href="?sheet=${encodeURIComponent(currentSheet)}&verse=${row.index - 1}" class="prev ${row.index <= 0 ? 'disabled' : ''}" ${row.index <= 0 ? '' : `onclick="navigateVerse(${row.index - 1}); return false;"`}>
        <img src="images/leftarrow_logo.png" alt="Previous" onerror="this.src='https://via.placeholder.com/40?text=←';">
      </a>
      <a href="?sheet=${encodeURIComponent(currentSheet)}&verse=${row.index + 1}" class="next ${row.index >= data.length - 1 ? 'disabled' : ''}" ${row.index >= data.length - 1 ? '' : `onclick="navigateVerse(${row.index + 1}); return false;"`}>
        <img src="images/rightarrow_logo.png" alt="Next" onerror="this.src='https://via.placeholder.com/40?text=→';">
      </a>
    </div>`;
    htmlContent += `<div class="reaction-buttons">
      <button data-reaction="like" onclick="toggleReaction('like', '${currentSheet}', ${row.index})">👍 <span id="likesCount">0</span></button>
      <button data-reaction="love" onclick="toggleReaction('love', '${currentSheet}', ${row.index})">❤️ <span id="lovesCount">0</span></button>
      <button data-reaction="angry" onclick="toggleReaction('angry', '${currentSheet}', ${row.index})">😡 <span id="commentsCount">0</span></button>
    </div>`;
    htmlContent += `</div><div class="single-verse-share-buttons">${addShareButton(verse, row.index, false)}</div>`;
    singleVerseElement.innerHTML = htmlContent;
    singleVerseElement.style.display = "block";
  }

  async function fetchReactions(sheet, verseIndex) {
    try {
      const reactionRef = doc(db, "reactions", `${sheet}_${verseIndex}`); // Fixed collection name
      const reactionSnapshot = await getDoc(reactionRef);
      const reactionCounts = reactionSnapshot.exists() ? reactionSnapshot.data() : { like: 0, love: 0, angry: 0 };
      updateReactionCountsDisplay(reactionCounts);

      const userId = localStorage.getItem('userId') || generateUniqueId();
      localStorage.setItem('userId', userId);
      const userReactionRef = doc(db, "user_reactions", `${sheet}_${verseIndex}_${userId}`);
      const userReactionSnapshot = await getDoc(userReactionRef);
      
      if (userReactionSnapshot.exists()) {
        const userReaction = userReactionSnapshot.data().reaction;
        const button = document.querySelector(`.reaction-buttons button[data-reaction="${userReaction}"]`);
        if (button) button.classList.add('active');
      }
    } catch (error) {
      console.error("Error loading reactions:", error);
    }
  }

  async function toggleReaction(reaction, sheet, verseIndex) {
    try {
      if (!db) throw new Error("Firestore not initialized");
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = generateUniqueId();
        localStorage.setItem('userId', userId); // Fix typo: was 'userId'
      }
      const reactionRef = doc(db, "reactions", `${sheet}_${verseIndex}`);
      const userReactionRef = doc(db, "user_reactions", `${sheet}_${verseIndex}_${userId}`);
      await runTransaction(db, async (transaction) => {
        const reactionDoc = await transaction.get(reactionRef);
        const userReactionDoc = await transaction.get(userReactionRef);
        
        let reactionCounts = reactionDoc.exists() ? reactionDoc.data() : { like: 0, love: 0, angry: 0 };
        const currentUserReaction = userReactionDoc.exists() ? userReactionDoc.data().reaction : null;

        let updates = {};
        if (currentUserReaction === reaction) {
          updates[reaction] = (reactionCounts[reaction] || 0) - 1;
          transaction.set(userReactionRef, { reaction: null }, { merge: true });
          document.querySelector(`.reaction-buttons button[data-reaction="${reaction}"]`)?.classList.remove('selected');
        } else {
          updates[reaction] = (reactionCounts[reaction] || 0) + 1;
          if (currentUserReaction) {
            updates[currentUserReaction] = (reactionCounts[currentUserReaction] || 0) - 1;
            document.querySelector(`.reaction-buttons button[data-reaction="${currentUserReaction}"]`)?.classList.remove('selected');
          }
          transaction.set(userReactionRef, { reaction: reaction }, { merge: true });
          document.querySelector(`.reaction-buttons button[data-reaction="${reaction}"]`)?.classList.add('selected');
        }

        updates = {
          like: updates.like ?? (reactionCounts.like ?? 0),
          love: updates.love ?? (reactionCounts.love ?? 0),
          angry: updates.angry ?? (reactionCounts.angry ?? 0)
        };

        transaction.set(reactionRef, updates, { merge: true });
      });

      const reactionSnapshot = await getDoc(reactionRef);
      const reactionCounts = reactionSnapshot.exists() ? reactionSnapshot.data() : { like: 0, love: 0, angry: 0 };
      updateReactionCountsDisplay(reactionCounts);
    } catch (error) {
      console.error("Error toggling reaction:", error.code, error.message);
      alert(`Failed to update reaction: ${error.message}. Please try again.`);
    }
  }

  function updateReactionCountsDisplay(counts) {
    const likesCount = document.querySelector('#likesCount');
    const lovesCount = document.querySelector('#lovesCount');
    const commentsCount = document.querySelector('#commentsCount');
    if (likesCount) likesCount.textContent = counts.like ?? 0;
    if (lovesCount) lovesCount.textContent = counts.love ?? 0;
    if (commentsCount) commentsCount.textContent = counts.angry ?? 0;
  }

  function generateUniqueId() {
    return 'user_' + Math.random().toString(36).substr(2, 9);
  }

  function navigateVerse(newIndex) {
    const verse = data[newIndex];
    const verseRowName = verse["Verse Name"] || verse["Verse"] || newIndex;
    history.pushState(null, '', `?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseRowName)}`);
    currentVerseIndex = newIndex;
    displaySingleVerseRow(verse, { index: newIndex });
    fetchReactions(currentSheet, newIndex);
  }

  function updateTableHeaders(sheetName) {
    const theadElement = document.getElementById("tableHeaders");
    theadElement.innerHTML = "";
    if (data.length > 0) {
      let trElement = document.createElement("tr");
      const headersList = Object.keys(data[0]).filter(h => h !== "sheet");
      headersList.forEach(header => {
        let thElement = document.createElement("th");
        thElement.textContent = header;
        thElement.classList.add(`${sheetName}-header`);
        trElement.appendChild(thElement);
      });
      let shareThElement = document.createElement("th");
      shareThElement.textContent = "Share";
      shareThElement.style.width = "60px";
      trElement.appendChild(shareThElement);
      theadElement.appendChild(trElement);
    }
  }

  function updateTableData(rows) {
    const tbodyElement = document.getElementById("verseBody");
    tbodyElement.innerHTML = "";
    if (rows.length === 0) {
      let trElement = document.createElement("tr");
      let tdElement = document.createElement("td");
      tdElement.textContent = "No verses available";
      tdElement.colSpan = 5;
      tdElement.style.textAlign = "center";
      trElement.appendChild(tdElement);
      tbodyElement.appendChild(trElement);
    } else {
      rows.forEach((row, index) => {
        let trElement = document.createElement("tr");
        const headersList = Object.keys(row).filter(h => h !== "sheet");
        headersList.forEach(header => {
          let tdElement = document.createElement("td");
          let content = row[header] || "";
          if (typeof content === "string" || (typeof content === "object" && content && content.text)) {
            const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
            if (searchTerm && !document.getElementById("searchInput").disabled) {
              const textToSearch = typeof content === "object" ? content.text : content;
              const highlightedText = textToSearch.replace(new RegExp(`(${searchTerm})`, 'gi'), '<mark>$1</mark>');
              content = typeof content === "object" ? { text: highlightedText, url: content.url } : highlightedText;
            }
            tdElement.innerHTML = typeof content === "object" && content.url
              ? `<a href="${content.url}" target="_blank">${content.text}</a>`
              : content;
          } else {
            tdElement.textContent = content || "-";
          }
          if (header === "Verse Category" && typeof row[header] === "string") {
            tdElement.className = getCategoryClassName(row[header].trim().toLowerCase());
          }
          trElement.appendChild(tdElement);
        });
        let shareTdElement = document.createElement("td");
        shareTdElement.className = "share-buttons";
        shareTdElement.innerHTML = addShareButton(row, index, true);
        trElement.appendChild(shareTdElement);
        tbodyElement.appendChild(trElement);
      });
    }
    updateContentCountDisplay(rows.length);
  }

  function getCategoryClassName(category) {
    switch (category?.toLowerCase()) {
      case "universal or ethical verse": return "category-universal";
      case "general intra-community verse": return "category-general";
      case "controversial intra-community verse": return "category-controversial";
      case "divisive or hateful inter-community verse": return "category-divisive";
      case "violent or aggressive inter-community verse": return "category-violent";
      default: return "";
    }
  }

  function addShareButton(row, index, isTableView = true) {
    const verseTextContent = row["Verse"] || row["Text"] || "";
    let verseRowName = row["Verse Name"] || row["Verse"] || index.toString();
    if (typeof verseRowName !== "string") {
      verseRowName = index.toString();
      console.warn(`Invalid Verse Name for sheet=${currentSheet}, index=${index}:`, verseRowName);
    }
    verseRowName = verseRowName.trim();
    const shareUrlLink = `https://subhendug1793.github.io/verse-viewer/?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseRowName)}`;
    const escapedShareUrlLink = shareUrlLink.replace(/'/g, "\\'");
    let htmlContent = '';
    if (isTableView) {
      htmlContent += `<a href="${shareUrlLink}" target="_blank" class="view-link"><img src="images/click_logo.png" alt="View" onerror="this.src='https://via.placeholder.com/24?text=👁';"></a>`;
    }
    htmlContent += `
      <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(verseTextContent + ' ' + shareUrlLink)}" target="_blank"><img src="images/whatsapp_logo.png" alt="WhatsApp"></a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrlLink)}" target="_blank"><img src="images/facebook_logo.png" alt="Facebook"></a>
      <a href="https://x.com/intent/tweet?text=${encodeURIComponent(verseTextContent)}&url=${encodeURIComponent(shareUrlLink)}" target="_blank"><img src="images/x_logo.png" alt="X"></a>
      <a href="#" onclick="copyToClipboard('${escapedShareUrlLink}'); return false;"><img src="images/link_logo.png" alt="Copy Link"></a>
      <a href="#" onclick="shareAnywhere('${verseTextContent.replace(/'/g, "\\'")}', '${escapedShareUrlLink}'); return false;"><img src="images/share_logo.png" alt="Share"></a>
    `;
    return htmlContent;
  }

  function filterTableData() {
    const categoryValue = document.getElementById("categoryFilter").value;
    const subCategoryValue = document.getElementById("subCategoryFilter").value;
    const sheetNameValue = document.getElementById("sheetSelector").value;
    const searchInputElement = document.getElementById("searchInput");
    const searchTermValue = searchInputElement.value.toLowerCase().trim();

    if (sheetNameValue && data.length > 0) {
      let filteredRowsData = data.filter(row => {
        const categoryMatchResult = !categoryValue || (row["Verse Category"] && typeof row["Verse Category"] === "string" && 
                                          row["Verse Category"].trim().toLowerCase() === categoryValue.toLowerCase());
        const subCategoryMatchResult = !subCategoryValue || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                                row["Sub Category"].trim().toLowerCase() === subCategoryValue.toLowerCase());
        return categoryMatchResult && subCategoryMatchResult;
      });
      updateTableData(filteredRowsData);
      if (searchTermValue) {
        searchTableData();
      } else {
        updateMatchCountDisplay(0);
      }
    }
  }

  function searchTableData() {
    const searchInputElement = document.getElementById("searchInput");
    if (searchInputElement.disabled) return; 
    const searchTermValue = searchInputElement.value.toLowerCase().trim();
    const categoryValue = document.getElementById("categoryFilter").value;
    const subCategoryValue = document.getElementById("subCategoryFilter").value;
    const sheetNameValue = document.getElementById("sheetSelector").value;

    if (sheetNameValue && data.length > 0) {
      let filteredRowsData = data.filter(row => {
        const categoryMatchResult = !categoryValue || (row["Verse Category"] && typeof row["Verse Category"] === "string" && 
                                          row["Verse Category"].trim().toLowerCase() === categoryValue.toLowerCase());
        const subCategoryMatchResult = !subCategoryValue || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                                row["Sub Category"].trim().toLowerCase() === subCategoryValue.toLowerCase());
        return categoryMatchResult && subCategoryMatchResult;
      });
      if (searchTermValue) {
        let searchFilteredRowsData = filteredRowsData.filter(row =>
          Object.values(row).some(val =>
            (typeof val === "string" && val.toLowerCase().includes(searchTermValue)) ||
            (typeof val === "object" && val && val.text && val.text.toLowerCase().includes(searchTermValue))
          )
        );
        let matchCountValue = 0;
        searchFilteredRowsData.forEach(row => {
          Object.values(row).forEach(val => {
            if (typeof val === "string" && val.toLowerCase().includes(searchTermValue)) {
              matchCountValue += (val.toLowerCase().match(new RegExp(searchTermValue, 'g')) || []).length;
            } else if (typeof val === "object" && val && val.text && val.text.toLowerCase().includes(searchTermValue)) {
              matchCountValue += (val.text.toLowerCase().match(new RegExp(searchTermValue, 'g')) || []).length;
            }
          });
        });
        updateTableData(searchFilteredRowsData);
        updateMatchCountDisplay(matchCountValue);
      } else {
        updateTableData(filteredRowsData);
        updateMatchCountDisplay(0);
      }
    } else {
      updateTableData(data);
      updateMatchCountDisplay(0);
    }
  }

  function updateContentCountDisplay(count) {
    const contentCount = document.getElementById("contentCount");
    if (contentCount) contentCount.textContent = `Content Found: ${count}`;
  }

  function updateMatchCountDisplay(count) {
    const matchCount = document.getElementById("matchCount");
    if (matchCount) matchCount.textContent = `Matches found: ${count}`;
  }

  window.loadSheetData = loadSheetData;
  window.filterTableData = filterTableData;
  window.searchTableData = searchTableData;
  window.navigateVerse = navigateVerse;
  window.toggleReaction = toggleReaction;

  window.onload = () => {
    initializeFirebase();
    updateLastUpdated();
    updateVisitorCount();
    loadSingleVerse();
    loadSheetData(); // Ensure table is initialized
  };
</script>
</body>
</html>
