<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASTIK GBQ+ Verse Filter</title>
  <meta property="og:title" content="SASTIK GBQ+ Verse">
  <meta property="og:description" content="Explore categorized theological verses from the Gita, Bible, Quran, and more.">
  <meta property="og:image" content="https://subhendug1793.github.io/verse-viewer/images/sastik_logo.png">
  <meta property="og:url" content="https://subhendug1793.github.io/verse-viewer/">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Poppins', sans-serif; 
      margin: 5px;
      background: #f9f9f9; 
      min-height: 100vh; 
      display: flex;
      flex-direction: column;
    }
    .header-info { 
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      font-size: 0.9em; 
      color: #666; 
      margin-bottom: 5px;
    }
    .header-info .visitor-count {
      text-align: left;
      font-weight: 500;
      color: #333;
    }
    .header-info .visitor-count.error {
      font-weight: normal;
      color: #999;
    }
    .header-info .last-updated {
      text-align: right;
    }
    .header-info .last-updated a {
      color: #0066cc;
      text-decoration: none;
    }
    .header-info .last-updated a:hover {
      text-decoration: underline;
    }
    .header-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 5px; 
    }
    .logo { 
      width: 80px; 
      height: auto; 
      margin-right: 10px; 
    }
    h2 { 
      font-family: 'Merriweather', serif;
      color: #0066cc;
      text-align: center; 
      margin: 0; 
      font-size: 1.8em;
      font-weight: 700; 
      white-space: nowrap; 
    }
    h2 a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    h2 a:hover { 
      text-decoration: underline; 
    }
    .mission-statement { 
      font-family: 'Merriweather', serif;
      text-align: center; 
      margin: 0 auto 5px;
      max-width: 80%; 
      font-size: 1.1em; 
      line-height: 1.5; 
      font-weight: 700; 
    }
    .mission-subtext { 
      text-align: center; 
      margin: 0 auto 10px; 
      max-width: 80%; 
      font-size: 0.7em; 
      line-height: 1.2; 
      font-weight: normal; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    .sheet-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .sheet-tab {
      padding: 8px 15px;
      background: #0066cc; 
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
    }
    .sheet-tab.selected {
      background: #FFFFFF; 
      color: #000000;
    }
    .sheet-tab:hover {
      opacity: 0.9;
    }
    .controls { 
      margin-bottom: 10px; 
      text-align: center; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 5px; 
      flex-wrap: wrap; 
    }
    .search-row { 
      display: none; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 5px;
    }
    .content-count, .match-count { 
      font-size: 1em; 
      color: #333; 
      text-align: left; 
    }
    .search-input-container {
      flex-grow: 0;
      text-align: center;
    }
    select, input { 
      padding: 5px; 
      margin-right: 10px;
      font-family: 'Poppins', sans-serif;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    select:disabled, input:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }
    #searchInput { 
      width: 200px; 
    }
    .verse-container {
      display: none; 
      width: 80%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .verse-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      width: 100%;
      overflow: hidden;
      text-align: center;
    }
    .verse-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to bottom, transparent, #fff);
      pointer-events: none;
    }
    .verse-name {
      font-family: 'Merriweather', serif;
      font-size: 1.3em;
      font-weight: 600;
      color: #000000;
      margin: 0 0 10px;
      text-align: center;
    }
    .verse-name a {
      color: #0066cc;
      text-decoration: underline;
    }
    .verse-card p {
      margin: 8px 0;
      font-size: 0.9em;
      text-align: center;
      display: block;
    }
    .verse-card .category {
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .see-full {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 5px 10px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      z-index: 10;
      pointer-events: auto;
    }
    .see-full:hover {
      background: #004c99;
    }
    .category-universal { 
      background-color: #00FF00; 
    }
    .category-general { 
      background-color: #00FFFF; 
    }
    .category-controversial { 
      background-color: #FFFF00; 
    }
    .category-divisive { 
      background-color: #FF0000; 
      color: #FFFFFF; 
    }
    .category-violent { 
      background-color: #000000; 
      color: #FFFFFF; 
    }
    .gita-header { 
      background-color: #FFA500; 
      color: #000000; 
      font-weight: bold; 
    }
    .bible-header { 
      background-color: #000080; 
      color: #FFFFFF; 
      font-weight: bold; 
    }
    .quran-header { 
      background-color: #006400; 
      color: #FFFFFF; 
      font-weight: bold; 
    }
    .hadith-header, .miscellaneous-header { 
      background-color: #FFFFFF; 
      color: #000000; 
      font-weight: 500; 
    }
    .single-verse-view { 
      text-align: center; 
      margin: 20px auto; 
      max-width: 80%; 
      padding: 20px; 
      background-color: #fff; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    }
    .single-verse-view h3 { 
      font-family: 'Merriweather', serif;
      color: #0066cc; 
      margin-bottom: 10px;
      font-weight: 700;
    }
    .verse-details { 
      margin-bottom: 20px; 
      text-align: left; 
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .verse-details p { 
      margin: 0; 
      font-family: 'Merriweather', serif;
      font-size: 1em; 
      display: flex;
      flex-wrap: wrap;
    }
    .verse-details strong { 
      width: 200px; 
      font-weight: 500;
      font-family: 'Poppins', sans-serif;
      flex-shrink: 0;
    }
    .share-buttons { 
      display: flex; 
      flex-direction: row; 
      justify-content: center; 
      gap: 12px; 
      flex-wrap: wrap; 
      margin-bottom: 10px;
    }
    .share-buttons img { 
      width: 24px; 
      height: 24px; 
      vertical-align: middle; 
    }
    .share-buttons a { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      width: 40px; 
    }
    .navigation-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }
    .navigation-buttons a {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      color: #0066cc;
      text-decoration: none;
      padding: 5px 10px;
      border: 1px solid #0066cc;
      border-radius: 4px;
    }
    .navigation-buttons a:hover {
      background-color: #e6f0ff;
    }
    .navigation-buttons a.disabled {
      color: #999;
      border-color: #999;
      cursor: not-allowed;
      pointer-events: none;
    }
    .reaction-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .reaction-buttons button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 18px;
    }
    .reaction-buttons button.active {
      font-weight: bold;
    }
    .reaction-buttons span {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      color: #333;
    }
    .footer { 
      margin-top: auto; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      max-width: 80%; 
      margin: 10px auto 0;
      padding: 10px 0; 
    }
    .footer a { 
      color: #0066cc;
      text-decoration: none; 
    }
    .footer a:hover { 
      text-decoration: underline; 
    }
    .footer img { 
      vertical-align: middle; 
    }
    .logos { 
      display: flex; 
      align-items: center; 
      margin-bottom: 5px; 
    }
    .logos img { 
      width: 60px; 
      height: auto; 
      margin-right: 5px; 
    }
    .text-group { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      text-align: center; 
    }
    .support-text { 
      font-weight: 500; 
      font-size: 0.9em; 
      margin-bottom: 10px; 
    }
    .support-text span { 
      display: block; 
    }
    .follow-text { 
      font-size: 1.1em; 
      margin: 2px 0; 
    }
    .name-text { 
      font-family: 'Merriweather', serif;
      font-size: 2em; 
      margin: 5px 0; 
    }
    .contact-text { 
      max-width: 90%; 
      text-align: center; 
    }
    .contact-text span { 
      display: block; 
      line-height: 1.4; 
    }
    .contact-text .main-contact { 
      font-size: 1.1em; 
      text-align: center; 
    }
    .contact-text img { 
      width: 20px; 
      height: auto; 
      vertical-align: middle; 
    }
    .qr-code { 
      margin: 10px 0; 
    }
    .qr-code img { 
      width: 200px; 
      height: auto; 
    }
    #errorDisplay {
      color: red;
      text-align: center;
      margin-bottom: 10px;
      font-size: 0.9em;
    }
    @media (max-width: 600px) {
      .header-info { 
        font-size: 0.8em; 
        margin-bottom: 5px;
        flex-wrap: wrap;
        gap: 5px;
      }
      .header-info .visitor-count, .header-info .last-updated {
        flex: 1;
      }
      .header-container { 
        flex-direction: column; 
        margin-bottom: 5px; 
      }
      .logo { 
        width: 50px; 
        margin-bottom: 5px; 
      }
      h2 { 
        font-size: 1.2em; 
      }
      .mission-statement { 
        font-size: 0.9em; 
        max-width: 90%; 
      }
      .mission-subtext { 
        font-size: 0.6em; 
        max-width: 90%; 
      }
      .sheet-tabs {
        gap: 5px;
      }
      .sheet-tab {
        padding: 6px 10px;
        font-size: 0.8em;
      }
      .controls { 
        flex-direction: column; 
        gap: 8px; 
      }
      select, input { 
        width: 100%; 
        margin-bottom: 8px; 
        padding: 4px; 
      }
      .search-row { 
        flex-direction: column; 
        gap: 8px; 
      }
      .content-count, .match-count { 
        text-align: center; 
      }
      .search-input-container { 
        width: 100%; 
      }
      #searchInput { 
        width: 100%; 
        max-width: 250px; 
      }
      .verse-container {
        width: 90%;
      }
      .verse-card {
        padding: 10px;
      }
      .verse-name {
        font-size: 1.1em;
      }
      .verse-card p {
        font-size: 0.8em;
      }
      .see-full {
        font-size: 0.7em;
        padding: 4px 8px;
      }
      .single-verse-view { 
        max-width: 90%; 
        padding: 15px; 
      }
      .verse-details p { 
        font-size: 0.9em; 
      }
      .verse-details strong { 
        width: 150px; 
      }
      .share-buttons img { 
        width: 20px; 
        height: 20px; 
      }
      .share-buttons a { 
        width: 30px; 
      }
      .navigation-buttons a {
        font-size: 0.8em;
        padding: 4px 8px;
      }
      .reaction-buttons button {
        font-size: 16px;
      }
      .footer { 
        max-width: 90%; 
      }
      .logos img { 
        width: 40px; 
        margin-right: 3px; 
      }
      .follow-text { 
        font-size: 0.9em; 
      }
      .contact-text .main-contact { 
        font-size: 0.85em; 
      }
      .qr-code img { 
        width: 150px; 
      }
      .support-text { 
        font-size: 0.7em; 
      }
    }
  </style>
</head>
<body>
  <div class="header-info">
    <span class="visitor-count" id="visitorCount">Visitors: Loading...</span>
    <span class="last-updated" id="lastUpdated">Last updated: Loading...</span>
  </div>
  <div class="header-container">
    <img src="images/sastik_logo.png" alt="SASTIK Logo" class="logo" onerror="this.style.display='none';console.log('SASTIK logo failed to load');">
    <h2><a href="https://www.facebook.com/sastikofficial/" target="_blank">SASTIK GBQ+</a></h2>
  </div>
  <div class="mission-statement">
    <b>‡¶∏‡ßÅ‡¶∏‡ßç‡¶• ‡¶Ü‡¶∏‡ßç‡¶§‡¶ø‡¶ï‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶ö‡¶æ‡¶∞‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá, ‡¶π‡¶ø‡¶Ç‡¶∏‡¶æ ‡¶ì ‡¶¨‡¶ø‡¶¶‡ßç‡¶¨‡ßá‡¶∑‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡ßá üö´ ‡¶∏‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡ßÄ‡¶§‡¶ø ‡¶ì ‡¶Æ‡¶æ‡¶®‡¶¨‡¶§‡¶æ‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‚úÖ</b><br>
    <b>To Propagate Sane Theism, Against Hatred and Violence üö´ In Favor of Harmony and Humanity ‚úÖ</b>
  </div>
  <div class="mission-subtext">
    ‚¨áÔ∏è A unified platform offering categorized and filtered theological verses based on modern-day relevance empowering you to wisely apply or disregard teachings and avoid the misguidance of charlatans. ‚¨áÔ∏è
  </div>
  <div class="sheet-tabs" id="sheetTabs">
    <button class="sheet-tab" data-sheet="gita">Gita</button>
    <button class="sheet-tab" data-sheet="bible">Bible</button>
    <button class="sheet-tab" data-sheet="quran">Quran</button>
    <button class="sheet-tab" data-sheet="hadith">Hadith</button>
    <button class="sheet-tab" data-sheet="miscellaneous">Miscellaneous</button>
  </div>
  <div class="controls" id="controls" style="display: none;">
    <label for="categoryFilter">Filter by Verse Category:</label>
    <select id="categoryFilter" disabled>
      <option value="">All</option>
      <option value="Universal or Ethical Verse">Universal or Ethical Verse</option>
      <option value="General Intra-community Verse">General Intra-community Verse</option>
      <option value="Controversial Intra-community Verse">Controversial Intra-community Verse</option>
      <option value="Divisive or Hateful Inter-community Verse">Divisive or Hateful Inter-community Verse</option>
      <option value="Violent or Aggressive Inter-community Verse">Violent or Aggressive Inter-community Verse</option>
    </select>
    <label for="subCategoryFilter">Filter by Sub Category:</label>
    <select id="subCategoryFilter" disabled>
      <option value="">All</option>
      <option value="Historical or Narrative verse">Historical or Narrative verse</option>
      <option value="Discriminatory or Prejudiced Verse">Discriminatory or Prejudiced Verse</option>
      <option value="Metaphorical or Symbolic verse">Metaphorical or Symbolic verse</option>
    </select>
  </div>
  <div id="errorDisplay"></div>
  <div class="search-row" id="search-row">
    <div class="content-count" id="contentCount">Content Found: 0</div>
    <div class="search-input-container">
      <input type="text" id="searchInput" placeholder="Search in table..." disabled onkeyup="searchTable()">
    </div>
    <div class="match-count" id="matchCount">Matches found: 0</div>
  </div>
  <div class="verse-container" id="verseContainer"></div>
  <div class="single-verse-view" id="singleVerseView" style="display: none;"></div>
  <div class="footer">
    <div class="text-group">
      <div class="support-text">
        <span>Developing and maintaining this unified platform requires continuous effort and dedication.</span>
        <span>We need your support to continue the SASTIK mission, which aims to create a better, harmonious society.</span>
        <span>You can encourage our efforts by scanning the <a href="upi://pay?pa=subhendu.srk1993-1@okicici&pn=Subhendu%20Ghosh&aid=uGICAgIDIy-m-Kw" target="_blank">UPI QR code</a> below üôè</span>
      </div>
      <div class="qr-code">
        <a href="upi://pay?pa=subhendu.srk1993-1@okicici&pn=Subhendu%20Ghosh&aid=uGICAgIDIy-m-Kw" target="_blank"><img src="images/qrcode_logo.jpg" alt="UPI QR Code" onerror="console.log('UPI QR code failed to load')"></a>
      </div>
      <div class="follow-text">For more insights, follow me on üëá</div>
      <div class="logos">
        <a href="https://www.facebook.com/SubhenduGhoshSastik/" target="_blank"><img src="images/facebook_logo.png" alt="Facebook" onerror="console.log('Facebook logo failed to load')"></a>
        <a href="https://www.youtube.com/@SGSastik" target="_blank"><img src="images/youtube_logo.png" alt="YouTube" onerror="console.log('YouTube logo failed to load')"></a>
        <a href="https://x.com/subhendug1793" target="_blank"><img src="images/x_logo.png" alt="X" onerror="console.log('X logo failed to load')"></a>
      </div>
      <div class="name-text">Subhendu Ghosh Sastik</div>
      <div class="contact-text">
        <span>If you‚Äôd like to contribute to verse updates üìú or have any suggestions or feedback üí≠</span>
        <span class="main-contact">Feel free to connect with <a href="https://m.me/subhendu.ghosh.790349" target="_blank">me</a> on <a href="https://t.me/Sg1793" target="_blank"><img src="images/telegram_logo.png" alt="Telegram"></a> or reach out via email at <a href="mailto:sastikofficial@gmail.com" target="_blank"><img src="images/gmail_logo.png" alt="Mail" onerror="console.log('Gmail logo failed to load')"></a> <a href="mailto:sastikofficial@gmail.com" target="_blank">sastikofficial@gmail.com</a></span>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCou0LOLpeijDPxHlVN1pvpruvxdrLKVWk",
    authDomain: "verseviewercounter.firebaseapp.com",
    projectId: "verseviewercounter",
    storageBucket: "verseviewercounter.firebasestorage.app",
    messagingSenderId: "486076065573",
    appId: "1:486076065573:web:363e819071b11880089ccc",
    measurementId: "G-NE4PCNMR8D"
  };

  let db = null;
  function initializeFirebase() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization failed:", error.message);
      document.getElementById("visitorCount").innerHTML = "Visitors: Unknown";
      document.getElementById("visitorCount").classList.add("error");
    }
  }

  async function updateVisitorCount() {
    const visitorCount = document.getElementById("visitorCount");
    if (!visitorCount) return;
    try {
      if (!db) throw new Error("Firestore not initialized");
      const counterRef = doc(db, "counters", "viewerCount");
      const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Firestore timeout")), 5000));
      await Promise.race([
        setDoc(counterRef, { count: increment(1) }, { merge: true }),
        timeoutPromise
      ]);
      const counterSnap = await Promise.race([
        getDoc(counterRef),
        timeoutPromise
      ]);
      if (counterSnap.exists()) {
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${counterSnap.data().count || 0}`;
      } else {
        throw new Error("Counter document does not exist");
      }
    } catch (error) {
      console.error("Error updating visitor count:", error.message);
      visitorCount.innerHTML = "Visitors: Unknown";
      visitorCount.classList.add("error");
    }
  }

  function updateLastUpdated() {
    const lastUpdatedElement = document.getElementById("lastUpdated");
    if (!lastUpdatedElement) return;
    try {
      let lastUpdated;
      const modified = document.lastModified;
      console.log("document.lastModified:", modified);
      if (modified && !isNaN(new Date(modified).getTime())) {
        const date = new Date(modified);
        lastUpdated = date.toLocaleString('en-IN', { 
          timeZone: 'Asia/Kolkata', 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false 
        }).replace(/(\d{2})\/(\d{2})\/(\d{4}),/, '$1/$2/$3');
      } else {
        console.warn("document.lastModified unavailable, using current date");
        const now = new Date();
        lastUpdated = now.toLocaleString('en-IN', { 
          timeZone: 'Asia/Kolkata', 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false 
        }).replace(/(\d{2})\/(\d{2})\/(\d{4}),/, '$1/$2/$3');
      }
      lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">${lastUpdated}</a>`;
    } catch (error) {
      console.error("Error updating last modified:", error.message);
      lastUpdatedElement.innerHTML = `Last updated: Unknown`;
    }
  }

  window.copyToClipboard = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Link copied to clipboard!");
    }).catch(err => {
      console.error("Failed to copy link:", err);
      alert("Failed to copy link. Please try again.");
    });
  };

  window.shareAnywhere = function(verseText, shareUrl) {
    if (navigator.share) {
      navigator.share({
        title: 'SASTIK GBQ+ Verse',
        text: verseText,
        url: shareUrl
      }).catch(err => console.error('Share error:', err));
    } else {
      alert('Share not supported on this browser. Copy the link instead.');
    }
  };

  let data = [];
  let filteredData = [];
  let currentSheet = "";
  let currentVerseIndex = -1;
  let isFiltered = false;

  async function loadSheetData(sheetName = "", fromPopstate = false, retries = 2) {
    console.log(`loadSheetData: sheetName=${sheetName}, fromPopstate=${fromPopstate}, retries=${retries}`);
    const controls = document.getElementById("controls");
    const searchRow = document.getElementById("search-row");
    const verseContainer = document.getElementById("verseContainer");
    const singleVerseView = document.getElementById("singleVerseView");
    const errorDisplay = document.getElementById("errorDisplay");
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    const tabs = document.querySelectorAll(".sheet-tab");

    // Reset UI state
    tabs.forEach(tab => tab.classList.remove("selected"));
    controls.style.display = "none";
    searchRow.style.display = "none";
    verseContainer.style.display = "none";
    singleVerseView.style.display = "none";
    errorDisplay.textContent = "";
    categoryFilter.disabled = true;
    subCategoryFilter.disabled = true;
    searchInput.disabled = true;
    data = [];
    filteredData = [];

    if (!sheetName || !['gita', 'bible', 'quran', 'hadith', 'miscellaneous'].includes(sheetName.toLowerCase())) {
      console.log("No valid sheet selected, resetting to home");
      currentSheet = "";
      sessionStorage.removeItem('currentSheet');
      if (!fromPopstate) {
        history.pushState({ view: 'home' }, '', '/verse-viewer/');
      }
      return;
    }

    // Normalize sheetName and highlight tab
    currentSheet = sheetName.toLowerCase();
    console.log(`Setting currentSheet to ${currentSheet}`);
    const tab = document.querySelector(`.sheet-tab[data-sheet="${currentSheet}"]`);
    if (tab) {
      tab.classList.add("selected");
      console.log(`Highlighted tab: ${currentSheet}`);
    } else {
      console.warn(`Tab not found for sheet: ${currentSheet}`);
    }

    sessionStorage.setItem('currentSheet', currentSheet);
    if (!fromPopstate) {
      history.pushState({ view: 'sheet', sheet: currentSheet }, '', `?sheet=${encodeURIComponent(currentSheet)}`);
    }

    // Show loading state
    controls.style.display = "flex";
    searchRow.style.display = "flex";
    verseContainer.style.display = "flex";
    errorDisplay.textContent = `Loading ${currentSheet} data...`;
    categoryFilter.disabled = false;
    subCategoryFilter.disabled = false;
    searchInput.disabled = false;

    // Try fetching JSON with multiple case variations
    const baseUrl = 'https://subhendug1793.github.io/verse-viewer/';
    const urlsToTry = [
      `${baseUrl}${currentSheet}.json`,
      `${baseUrl}${currentSheet.toLowerCase()}.json`,
      `${baseUrl}${currentSheet.toUpperCase()}.json`,
      `${baseUrl}${currentSheet.charAt(0).toUpperCase() + currentSheet.slice(1).toLowerCase()}.json`
    ];
    let sheetData = null;
    for (const url of urlsToTry) {
      try {
        console.log(`Attempting to fetch: ${url}`);
        const response = await fetch(url, { cache: 'no-store' });
        console.log(`Fetch status for ${url}: ${response.status}`);
        if (response.ok) {
          sheetData = await response.json();
          break;
        } else {
          console.warn(`Fetch failed for ${url}: Status ${response.status}`);
        }
      } catch (err) {
        console.warn(`Error fetching ${url}:`, err.message);
      }
    }

    if (sheetData && Array.isArray(sheetData)) {
      console.log(`Loaded ${sheetData.length} records for ${currentSheet}`, sheetData.slice(0, 2));
      data = sheetData;
      filteredData = data;
      errorDisplay.textContent = "";
      resetFilters();
      filterTable();
      updateContentCount(data.length);
      updateMatchCount(0);
    } else if (retries > 0) {
      console.warn(`Retrying loadSheetData for ${currentSheet}, retries left: ${retries - 1}`);
      setTimeout(() => loadSheetData(sheetName, fromPopstate, retries - 1), 1000);
    } else {
      console.error(`Failed to load ${currentSheet}.json after all attempts`);
      errorDisplay.textContent = `Unable to load ${currentSheet} data. Please check if ${currentSheet}.json exists or try again later.`;
      verseContainer.innerHTML = `<p style="text-align: center;">Failed to load ${currentSheet} data</p>`;
      updateContentCount(0);
      updateMatchCount(0);
    }
  }

  function resetFilters() {
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    categoryFilter.value = "";
    subCategoryFilter.value = "";
    sessionStorage.removeItem(`filter_category_${currentSheet}`);
    sessionStorage.removeItem(`filter_subCategory_${currentSheet}`);
  }

  async function loadSingleVerse(sheet, verseParam, fromPopstate = false) {
    console.log(`loadSingleVerse: sheet=${sheet}, verseParam=${verseParam}, fromPopstate=${fromPopstate}`);
    const singleVerseView = document.getElementById("singleVerseView");
    const controls = document.getElementById("controls");
    const verseContainer = document.getElementById("verseContainer");
    const searchRow = document.getElementById("search-row");

    if (sheet && verseParam && ['gita', 'bible', 'quran', 'hadith', 'miscellaneous'].includes(sheet.toLowerCase())) {
      currentSheet = sheet.toLowerCase();
      sessionStorage.setItem('currentSheet', currentSheet);
      const baseUrl = 'https://subhendug1793.github.io/verse-viewer/';
      const urlsToTry = [
        `${baseUrl}${currentSheet}.json`,
        `${baseUrl}${currentSheet.toLowerCase()}.json`,
        `${baseUrl}${currentSheet.toUpperCase()}.json`,
        `${baseUrl}${currentSheet.charAt(0).toUpperCase() + currentSheet.slice(1).toLowerCase()}.json`
      ];
      let sheetData;
      for (const url of urlsToTry) {
        try {
          console.log(`Attempting to fetch for single verse: ${url}`);
          const response = await fetch(url, { cache: 'no-store' });
          if (response.ok) {
            sheetData = await response.json();
            break;
          }
        } catch (err) {
          console.warn(`Error fetching ${url}:`, err.message);
        }
      }
      if (sheetData && Array.isArray(sheetData)) {
        data = sheetData;
        filteredData = data;
        const normalizedVerseParam = decodeURIComponent(verseParam).trim();
        let verseIndex = data.findIndex(row => {
          const verseName = (row["Verse Name"] || row["Verse"] || "").trim();
          return verseName === normalizedVerseParam;
        });
        if (verseIndex === -1) {
          verseIndex = parseInt(verseParam, 10);
          if (isNaN(verseIndex)) verseIndex = -1;
        }
        if (verseIndex >= 0 && verseIndex < data.length) {
          currentVerseIndex = verseIndex;
          const verse = data[verseIndex];
          const verseName = verse["Verse Name"] || verse["Verse"] || verseIndex.toString();
          if (!fromPopstate) {
            history.pushState({ view: 'verse', sheet: currentSheet, verse: verseName, index: verseIndex }, '', `?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseName)}`);
          }
          displaySingleVerse(verse, verseIndex);
          singleVerseView.style.display = "block";
          controls.style.display = "none";
          verseContainer.style.display = "none";
          searchRow.style.display = "none";
          await loadReactions(currentSheet, verseIndex);
        } else {
          displaySingleVerse(null, -1);
          singleVerseView.style.display = "block";
          controls.style.display = "none";
          verseContainer.style.display = "none";
          searchRow.style.display = "none";
        }
      } else {
        displaySingleVerse(null, -1);
        singleVerseView.style.display = "block";
        controls.style.display = "none";
        verseContainer.style.display = "none";
        searchRow.style.display = "none";
      }
    } else {
      loadSheetData("", fromPopstate);
    }
  }

  async function loadReactions(sheet, verseIndex) {
    try {
      const reactionRef = doc(db, "reactions", `${sheet}_${verseIndex}`);
      const reactionSnap = await getDoc(reactionRef);
      const reactionCounts = reactionSnap.exists() ? reactionSnap.data() : { like: 0, love: 0, angry: 0 };
      updateReactionButtons(reactionCounts);
      const userId = localStorage.getItem('userId') || generateUserId();
      localStorage.setItem('userId', userId);
      const userReactionRef = doc(db, "user_reactions", `${sheet}_${verseIndex}_${userId}`);
      const userReactionSnap = await getDoc(userReactionRef);
      if (userReactionSnap.exists()) {
        const userReaction = userReactionSnap.data().reaction;
        const button = document.querySelector(`.reaction-buttons button[data-reaction="${userReaction}"]`);
        if (button) button.classList.add('active');
      }
    } catch (error) {
      console.error("Error loading reactions:", error.message);
    }
  }

  async function toggleReaction(reaction, sheet, verseIndex) {
    try {
      const userId = localStorage.getItem('userId') || generateUserId();
      localStorage.setItem('userId', userId);
      const reactionRef = doc(db, "reactions", `${sheet}_${verseIndex}`);
      const userReactionRef = doc(db, "user_reactions", `${sheet}_${verseIndex}_${userId}`);

      await db.runTransaction(async (transaction) => {
        const reactionSnap = await transaction.get(reactionRef);
        const userReactionSnap = await transaction.get(userReactionRef);
        const currentReaction = userReactionSnap.exists() ? userReactionSnap.data().reaction : null;
        let updates = { like: 0, love: 0, angry: 0 };

        if (reactionSnap.exists()) {
          updates = { ...reactionSnap.data() };
        }

        if (currentReaction === reaction) {
          updates[reaction] = (updates[reaction] || 0) - 1;
          transaction.set(userReactionRef, { reaction: null });
        } else {
          if (currentReaction) {
            updates[currentReaction] = (updates[currentReaction] || 0) - 1;
          }
          updates[reaction] = (updates[reaction] || 0) + 1;
          transaction.set(userReactionRef, { reaction: reaction });
        }

        transaction.set(reactionRef, updates);
      });

      await loadReactions(sheet, verseIndex);
    } catch (error) {
      console.error("Error toggling reaction:", error.message);
      alert("Failed to update reaction. Please try again later.");
    }
  }

  function updateReactionButtons(counts) {
    const likeCount = document.querySelector('#likeCount');
    const loveCount = document.querySelector('#loveCount');
    const angryCount = document.querySelector('#angryCount');
    if (likeCount) likeCount.textContent = counts[like] || 0;
    if (loveCount) loveCount.textContent = counts[love] || 0;
    if (angryCount) angryCount.textContent = counts.angry || 0;
  }

  function generateUserId() {
    return 'user_' + Math.random().toString(36).substr(2, 9);
  }

  function getBengaliCategory(category) {
    const map = {
      "universal or ethical verse": "‡¶∏‡¶∞‡ßç‡¶¨‡¶ú‡¶®‡ßÄ‡¶® ‡¶¨‡¶æ ‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "general intra-community verse": "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶É‡¶∏‡ßç‡¶Æ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "controversial intra-community verse": "‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶Ö‡¶®‡ßç‡¶§‡¶É‡¶∏‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "divisive or hateful inter-community verse": "‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶¨‡¶æ ‡¶¨‡¶ø‡¶¶‡ßç‡¶¨‡ßá‡¶∑‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶Ü‡¶®‡ßç‡¶§‡¶É‡¶∏‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "violent or aggressive inter-community verse": "‡¶π‡¶ø‡¶Ç‡¶∏‡ßç‡¶∞ ‡¶¨‡¶æ ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶Ü‡¶®‡ßç‡¶§‡¶É‡¶∏‡ßç‡¶Æ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "historical or narrative verse": "‡¶ê‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶ï‡¶æ‡¶π‡¶ø‡¶®‡ßÄ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "metaphorical or symbolic verse": "‡¶∞‡ßÇ‡¶™‡¶ï ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï‡ßÄ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
      "discriminatory or prejudiced verse": "‡¶¨‡ßà‡¶∑‡¶Æ‡ßç‡¶Ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡¶æ ‡¶™‡¶ï‡ßç‡¶∑‡¶™‡¶æ‡¶§‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶∂‡ßç‡¶≤‡ßã‡¶ï",
    };
    return map[category.toLowerCase()] || category || "";
  }

  function getCategoryClass(category) {
    switch (category?.toLowerCase()?.trim() || "") {
      case "universal or ethical verse": return "category-universal";
      case "general intra-community verse": return "category-general";
      case "controversial intra-community verse": return "category-controversial";
      case "divisive or hateful inter-community verse": return "category-divisive";
      case "violent or aggressive inter-community verse": return "category-violent";
      default: return "";
    };
  }

  function displaySingleVerse(verse, index) {
    console.log(`displaySingleVerse: index=${index}, verse=`, verse);
    const singleVerseView = document.getElementById("singleVerseView");
    if (!verse) {
      singleVerseView.innerHTML = `<h3>Error</h3><p>Verse not found.</p>`;
      singleVerseView.style.display = "block";
      return;
    }
    const verseName = verse["Verse Name"] || verse["Verse"] || "Verse";
    const heading = `${currentSheet.charAt(0).toUpperCase()}${currentSheet.slice(1)} ${verseName}`;
    console.log(`Rendering single verse: ${heading}`);
    let html = `<h3>${heading}</h3><div class="verse-details">`;
    const headers = Object.keys(verse).filter(h => h !== "sheet");
    console.log("Headers for single verse:", headers);
    headers.forEach(header => {
      let content = verse[header] || "-";
      if (content && content && typeof content === "object" && content.text && content.url) {
        content = `<a href="${content.url}" target="_blank">${content.text}</a>`;
      }
      const className = header === "Verse Category" ? getCategoryClass(content) : "";
      html += `<p>${className ? ` class="${className}"` : ""}><strong>${header}:</strong> <span>${content}</span>${header === "Verse Category" || header === "Sub Category" ? ` / ${getBengaliCategory(verse[header] || "")}` : ""}</p>`;
    });
    html += `<div class="reaction-buttons">
      <button data-reaction="like" onclick="toggleReaction('like', '${currentSheet}', ${index})">üëç <span id="likeCount">0</span></button>
      <button data-reaction="love" onclick="toggleReaction('love', '${currentSheet}', ${index})">‚ù§Ô∏è <span id="loveCount">0</span></button>
      <button data-reaction="angry" onclick="toggleReaction('angry', '${currentSheet}', ${index})">üò° <span id="angryCount">0</span></button>
    </div>`;
    html += `</div><div class="share-buttons">${addShareButton(verse, index)}</div>`;
    const prevDisabled = index <= 0 ? 'disabled' : '';
    const nextDisabled = index >= data.length - 1 ? 'disabled' : '');
    const verseNamePrev = data[index - 1]?.["Verse Name"] || data[index - 1]?.["Verse"] || (index - 1).toString();
    const verseNameNext = data[index + 1]?["Verse Name"] || data[index + 1]?.["Verse"] || (index + 1).toString();
    html += `<div class="navigation-buttons">
      <a href="?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseNamePrev)}" class="prev ${prevDisabled}" ${prevDisabled ? '' : `onclick="navigateVerse(${index - 1}); return false;"`}>><</a>
      <a href="/verse-viewer/" target="_blank" onclick="loadHome(); return false;">Home</a>
      <a href="?sheet=${encodeURIComponent(currentSheet)}" onclick="loadSheetData('${currentSheet}'); return false;">Back to ${currentSheet.charAt(0).toUpperCase()}${currentSheet.slice(1)}</a>
      <a href="?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseNameNext)}" class="next ${nextDisabled}" ${nextDisabled ? '' : `onclick="navigateVerse(${index + 1}); return false;"`}>"></a>
    </div>`;
    singleVerseView.innerHTML = html;
    singleVerseView.style.display = "block";
  }

  function addShareButton(row, index) {
    const verseText = row["Verse"] || row["Text"] || "";
    const verseName = row["Verse Name"] || row["Verse"] || index.toString();
    const shareUrl = `https://subhendug1793.github.io/verse-viewer/?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseName)}`;
    const escapedShareUrl = shareUrl.replace(/'/g, "\\'\'");
    console.log(`Generating share URL: ${shareUrl}`);
    return `
      <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(verseText + ' ' + shareUrl)}" target="_blank"><img src="images/whatsapp_logo.png" alt="WhatsApp"></a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&display=popup" target="_blank"><img src="Facebook" alt="Facebook"></a>
      <a href="https://x.com/intent/tweet?text=${encodeURIComponent(verseText)}&url=${encodeURIComponent(shareUrl)}" target="_blank"><img src="images/x_logo.png" alt="X"></a>
      <a href="#" onclick="copyToClipboard('https://${encodeURIComponent('https://escapedShareUrl}'); return false;"><img src="https://images/link_logo.png" alt="Copy Link"></a>
      <a href="#" onclick="shareAnywhere('https://${encodeURIComponent('https://verseText.replace(/'/g, "\\'\'")}', '${escapedShareUrl}'); return false;"><img src="https://images/share_logo.png" alt="Share"></a>
    `;
  }

  function updateVerseCards(rows) {
    console.log(`updateVerseCards: Rendering ${rows.length} verses for ${currentSheet}`);
    const verseContainer = document.getElementById("verseContainer");
    verseContainer.innerHTML = "";
    if (rows.length === 0) {
      verseContainer.innerHTML = `<p style="text-align: center;">No verses found</p>`;
      return;
    }
    rows.forEach((row =>, filteredIndex, index => {
      console.log(`Rendering verse at filteredIndex ${filteredIndex}:`, row);
      const verseName = row["Verse Name"] || row["Verse"] || ", filteredVerse, rowIndex.toString();
      const verseCategory = row["Verse Category"] || "";
      const subCategory = row["Sub Category"] || "";
      const transliteration = row["Verse Transliteration"] || ["Transliteration"] || "";
      const bengaliTranslation = row["Bengali Translation"] || ["bengali_translation"] || "";
      const translation = row["Translation"] || ["English Translation"] || "";
      const dataIndex = data.findIndex(item => item["Verse Name"] === row["Verse Name"] && item["Verse"].=== row["Verse"]);
      console.log(`Mapped to dataIndex: ${dataIndex}`);
      let html = `<div class="verse-card" data-filtered-index="${filteredIndex}" data-data-index="${dataIndex}">${`
        <div class="${verse-}name">${typeof verseName === "object" && verseName && verseName.text && verseName.url ? `<a href="${verseName.text.url}" target="_blank">${verseName.text}</a>` : verseName}</div>`;
      const fields = [
        { label: "Verse Category", value: verseCategory, className: getCategoryClass(verseCategory), key: "Verse Category" },
        { label: "Sub Category", value: subCategory, key: "Sub Category" },
        { label: "Verse Transliteration", value: transliteration, key: "Transliteration", },
        { label: "Bengali Translation", value: bengaliTranslation, key: "Bengali Translation", },
        { label: "English Translation", value: translation, key: "Translation", }
      ].filter(([_, { value }]) => value).slice(0, 5); // Limit to 5 non-empty fields
      console.log(`Fields for verse ${verseName}:`, fields);
      fields.forEach((({label, value, className, key}) => {
        html += `<p${className ? ` class="${className}"` : ""}"><strong>${label}:</strong> ${value}${key === "Verse Category" || key === "Sub Category" ? ` / ${getBengaliCategory(value)}` : ""}</p>`;
      });
      // Add any additional fields not in fields array
      Object.keys(row).forEach(key => {
        if (!fields.some(f => f.key === key) && key !== "Verse Name" && key !== "Verse" && row[key]) {
          html += `<p><strong>p${key}:</strong>: ${row[key]}</p>`;
          console.log(`Added additional field ${key}: ${row[key]}`);
        });
      });
      html += `<button class="see-full" onclick="showFullVerse(${dataIndex})">See Full Verse</button></div>`;
      verseContainer.innerHTML += html;
    });
  }

  window.showFullVerse = function showFullVerse(dataIndex) => {
    console.log(`showFullVerse: dataIndex=${dataIndex}`);
    const verse = data[dataIndex];
    if (verse !== null, verse) {
      console.log(`Displaying full verse for dataIndex=${dataIndex}, verse=`, verse);
      displaySingleVerse({verse, dataIndex);
    } else {
      console.error("Verse not found at dataIndex:", dataIndex);
      document.getElementById("errorDisplay").textContent = "Error displaying full verse.";
    }
  });

  function filterTable() {
    console.log("Filtering table...");
    const category = document.getElementById("categoryFilter").value.toLowerCase().trim();
    const subCategory = document.getElementById("subCategoryFilter").value.toLowerCase();
    console.log(`Filter criteria: category=${category}, subCategory=${subCategory}`);

    if (currentSheet && data.length > 0) {
      sessionStorage.setItem(`filter_category_${currentSheet}`, category);
      sessionStorage.setItem(`filter_subCategory_${currentSheet}`, subCategory);
      filteredData = data.filter(row => {
        const categoryMatch = !category || (row["Verse Category"]?.trim()?.toLowerCase() || "") === category;
        const subCategoryMatch = !subCategory || (row["subCategory"]?.trim()?.toLowerCase() || "") === subCategory;
        console.log(`Row:`, row, `Category Match: ${categoryMatch}, SubCategory Match: ${subCategoryMatch}`);
        return categoryMatch && subCategoryMatch;
      });
      console.log(`Filtered ${filteredData.length} records`);
      isFiltered = category || subCategory;
      updateVerseCards(filteredData);
      searchTable();
    }
  }

  function searchTable() {
    const searchInput = document.getElementById("searchInput");
    if (searchInput.disabled) return;
    const searchTerm = searchInput.value.toLowerCase().trim();
    let matchCount = 0;
    let searchFilteredRows = filteredData;
    if (searchTerm) {
      searchFilteredRows = filteredData.filter(row =>
        row => Object.values(row).some(val =>
          (typeof val === "string" && val.toLowerCase().trim().includes(searchTerm)) ||
          (typeof val === "object' && val && val.text && val.text.toLowerCase().includes(searchTerm))
        )
      );
      searchFilteredRows.forEach(row => {
        Object.values(row).forEach(val => {
          if (typeof val === "string" && val.toLowerCase().includes(searchTerm)) {
            matchCount += (val.toLowerCase().match(new RegExp(searchTerm, 'g'))?.length || []) || 0).length;
          } else if (typeof val === "object" && val && val.text && val.text.toLowerCase().includes(searchTerm)) {
            matchCount += (val.text.toLowerCase().match(/new RegExp(searchTerm, 'g'))?.length || []) || 0).length;
          }
        });
      });
    }
    console.log(`Search filtered: ${searchFilteredRows.length} rows, ${matchCount} matches`);
    updateVerseCards(searchFilteredRows);
    updateMatchCount(matchCount);
  }

  function updateContentCount(count) {
    document.getElementById("contentCount").textContent = `Content Found: ${count}`;
  }

  function updateMatchCount(count) {
    document.getElementById("matchCount").textContent = `Matches found: ${count}`;
  }

  function navigateVerse(newIndex) {
    const verse = data[newIndex];
    const verseName = verse["Verse Name"] || verse["Verse"] || newIndex.toString();
    history.pushState({ view: 'verse', sheet: currentSheet, verse: verseName, index: newIndex }, '', `?sheet=${encodeURIComponent(currentSheet)}&verse=${encodeURIComponent(verseName)}`);
    currentVerseIndex = newIndex;
    displaySingleVerse(verse, newIndex);
    loadReactions(currentSheet, newIndex);
  }

  function loadHome(fromPopstate = false) {
    currentSheet = "";
    sessionStorage.removeItem('currentSheet');
    if (!fromPopstate) {
      history.pushState({ view: 'home' }, '', '/verse-viewer/');
    }
    loadSheetData("");
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function handleTabClick(event) {
    const sheetName = event.target.dataset.sheet;
    if (sheetName) {
      console.log(`Tab clicked: ${sheetName}`);
      if (sheetName.toLowerCase() === currentSheet) {
        console.log(`Unclicking tab: ${sheetName}`);
        loadHome();
      } else {
        loadSheetData(sheetName);
      }
    } else {
      console.warn("No data-sheet attribute found on clicked tab");
    }
  }

  window.onpopstate = function(event) {
    const state = event.state || {};
    if (state.view === 'verse' && state.sheet && state.verse) {
      loadSingleVerse(state.sheet, state.verse, true);
    } else if (state.view === 'sheet' && state.sheet) {
      loadSheetData(state.sheet, true);
    } else {
      loadHome(true);
    }
  };

  window.loadSheetData = loadSheetData;
  window.filterTable = filterTable;
  window.searchTable = debounce(searchTable, 200);
  window.navigateVerse = navigateVerse;
  window.toggleReaction = toggleReaction;
  window.loadHome = loadHome;

  window.onload = async () => {
    console.log("Window loaded, initializing...");
    initializeFirebase();
    updateLastUpdated();
    await updateVisitorCount();
    const params = new URLSearchParams(window.location.search);
    const sheet = params.get("sheet");
    const verse = params.get("verse");
    if (sheet && verse) {
      loadSingleVerse(sheet, verse);
    } else if (sheet) {
      loadSheetData(sheet);
    } else {
      loadHome();
    }
    const tabs = document.querySelectorAll(".sheet-tab");
    tabs.forEach(tab => {
      tab.removeEventListener("click", handleTabClick);
      tab.addEventListener("click", handleTabClick);
      console.log(`Attached click listener to tab: ${tab.dataset.sheet}`);
    });
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    if (categoryFilter) {
      categoryFilter.removeEventListener("change", filterTable);
      categoryFilter.addEventListener("change", debounce(filterTable, 200));
      console.log("Attached change listener to categoryFilter");
    }
    if (subCategoryFilter) {
      subCategoryFilter.removeEventListener("change", filterTable);
      subCategoryFilter.addEventListener("change", debounce(filterTable, 200));
      console.log("Attached change listener to subCategoryFilter");
    }
  };
</script>
</body>
</html>
