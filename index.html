<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASTIK GBQ+ Verse Filter</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: linear-gradient(to bottom, #f9f9f9, #e6f3e6); /* Subtle gradient for visual appeal */
      position: relative; 
      min-height: 100vh; 
      display: flex;
      flex-direction: column;
    }
    .header-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .header-info { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      font-size: 0.9em; 
      color: #666; 
      z-index: 10; 
    }
    .header-info .last-updated a {
      color: #0066cc;
      text-decoration: none;
    }
    .header-info .visitor-count {
      margin-left: 20px;
      vertical-align: middle;
      display: inline-block;
      min-height: 20px; 
      font-weight: bold;
      color: #333;
      z-index: 10;
    }
    .header-info .visitor-count.error {
      font-weight: normal;
      color: #999;
    }
    .logo { 
      width: 80px; 
      height: auto; 
      margin-right: 10px; 
    }
    h2 { 
      color: #0066cc;
      text-align: center; 
      margin: 0; 
      font-size: 1.8em;
      font-weight: bold; 
      white-space: nowrap; 
      text-decoration: none; 
    }
    h2 a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    h2 a:hover { 
      text-decoration: underline; 
    }
    .mission-statement { 
      text-align: center; 
      margin: 0 auto 10px;
      max-width: 80%; 
      font-size: 1.1em; 
      line-height: 1.5; 
      font-weight: bold; 
    }
    .mission-subtext { 
      text-align: center; 
      margin: 0 auto 20px; 
      max-width: 80%; 
      font-size: 0.8em;
      line-height: 1.2; 
      font-weight: normal; 
    }
    .controls { 
      margin-bottom: 10px; 
      text-align: center; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 2px; 
      flex-wrap: wrap; 
    }
    .search-row { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 5px;
    }
    .content-count, .match-count { 
      font-size: 1em; 
      color: #333; 
      text-align: left; 
    }
    .search-input-container {
      flex-grow: 0;
      text-align: center;
    }
    select, input { 
      padding: 5px; 
      margin-right: 10px; 
    }
    select:disabled, input:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }
    #searchInput { 
      width: 200px; 
    }
    table { 
      border-collapse: collapse; 
      width: 80%; 
      margin: 0 auto 5px;
      background-color: #fff; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      position: relative; 
      z-index: 1; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center; 
    }
    td a { 
      color: #0066cc; 
      text-decoration: none; 
    }
    td a:hover { 
      text-decoration: underline; 
    }
    td.category-universal { 
      background-color: #00FF00; 
    }
    td.category-general { 
      background-color: #00FFFF; 
    }
    td.category-controversial { 
      background-color: #FFFF00; 
    }
    td.category-divisive { 
      background-color: #FF0000; 
    }
    td.category-violent { 
      background-color: #000000; 
      color: #FFFFFF; 
    }
    th.gita-header { 
      background-color: #ffe4b5; 
      color: black; 
    }
    th.bible-header { 
      background-color: #add8e6; 
      color: white; 
    }
    th.quran-header { 
      background-color: #e6f3e6; 
      color: white; 
    }
    th.hadith-header, th.miscellaneous-header { 
      background-color: #4CAF50; 
      color: white; 
    }
    mark { 
      background-color: yellow; 
      font-weight: bold; 
    }
    .footer { 
      position: relative; 
      margin-top: auto; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      max-width: 80%; 
      margin: 5px auto 0;
      padding: 10px 0; 
      pointer-events: auto; 
    }
    .footer a { 
      text-decoration: none; 
      cursor: pointer; 
      pointer-events: auto; 
    }
    .footer img { 
      vertical-align: middle; 
      pointer-events: auto; 
    }
    .logos { 
      display: flex; 
      align-items: center; 
      margin-bottom: 5px; 
    }
    .logos img { 
      width: 60px; 
      height: auto; 
      margin-right: 5px; 
    }
    .logos img:last-child { 
      margin-right: 0; 
    }
    .text-group { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      text-align: center; 
    }
    .support-text { 
      font-weight: bold; 
      font-size: 0.9em; 
      margin-bottom: 10px; 
    }
    .support-text span { 
      display: block; 
    }
    .follow-text { 
      font-size: 1.1em; 
      margin: 2px 0; 
    }
    .name-text { 
      font-size: 2em; 
      margin: 5px 0; 
    }
    .contact-text { 
      font-size: 1em; 
      max-width: 90%; 
      text-align: center; 
      pointer-events: auto; 
    }
    .contact-text span { 
      display: block; 
      white-space: nowrap; 
      line-height: 1.4; 
    }
    .contact-text img { 
      width: 20px; 
      height: auto; 
      vertical-align: middle; 
    }
    .qr-code { 
      margin: 10px 0; 
    }
    .qr-code img { 
      width: 200px; 
      height: auto; 
    }
    .category-icon { 
      margin-right: 5px; 
    }
    .verse-of-day { 
      text-align: center; 
      margin: 20px auto; 
      max-width: 80%; 
      padding: 10px; 
      background-color: #fff; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1); 
    }
    .verse-of-day h3 { 
      color: #0066cc; 
      margin: 0 0 10px; 
    }
    .related-verses { 
      text-align: center; 
      margin: 20px auto; 
      max-width: 80%; 
      padding: 10px; 
      background-color: #fff; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1); 
    }
    .related-verses h3 { 
      color: #0066cc; 
      margin: 0 0 10px; 
    }
    .feedback { 
      text-align: center; 
      margin: 20px auto; 
      max-width: 80%; 
      padding: 10px; 
      background-color: #fff; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1); 
    }
    .feedback textarea { 
      width: 100%; 
      max-width: 300px; 
      height: 100px; 
      margin-bottom: 10px; 
    }
    .comment-modal { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background-color: #fff; 
      padding: 20px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.3); 
      z-index: 1000; 
    }
    .comment-modal.active { 
      display: block; 
    }
    .overlay { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 999; 
    }
    .overlay.active { 
      display: block; 
    }
    .share-buttons a { 
      margin: 0 5px; 
      font-size: 0.9em; 
    }
    @media (max-width: 600px) {
      .header-info { 
        position: relative; 
        top: 0; 
        right: 0; 
        text-align: center; 
        margin: 10px 0; 
        font-size: 0.8em; 
      }
      .header-container { 
        flex-direction: column; 
        text-align: center; 
        margin-bottom: 10px; 
      }
      .logo { 
        margin-right: 0; 
        margin-bottom: 5px; 
        width: 50px; 
      }
      h2 { 
        font-size: 1.2em; 
      }
      .mission-statement { 
        font-size: 0.9em; 
        max-width: 90%; 
      }
      .mission-subtext { 
        font-size: 0.7em; 
        max-width: 90%; 
      }
      select, input { 
        width: 100%; 
        margin-bottom: 8px; 
        padding: 4px; 
      }
      .controls { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
      }
      .search-row { 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 5px;
      }
      .content-count, .match-count { 
        text-align: center; 
      }
      .search-input-container { 
        width: 100%; 
      }
      #searchInput { 
        width: 100%; 
        max-width: 250px; 
      }
      table { 
        width: 100%; 
        font-size: 0.9em; 
        margin-bottom: 5px;
      }
      th, td { 
        padding: 6px; 
      }
      .verseBody td:nth-child(n+3) { 
        display: none; 
      }
      .verseBody tr { 
        cursor: pointer; 
      }
      .verseBody tr.expanded td { 
        display: table-cell; 
      }
      .footer { 
        max-width: 90%; 
        margin: 5px auto 0;
      }
      .logos img { 
        width: 40px; 
        margin-right: 3px; 
      }
      .logos img:last-child { 
        margin-right: 0; 
      }
      .follow-text { 
        font-size: 0.9em; 
      }
      .contact-text { 
        font-size: 0.75em; 
      }
      .contact-text img { 
        width: 20px; 
      }
      .qr-code img { 
        width: 150px; 
      }
      .support-text { 
        font-size: 0.7em; 
      }
      .feedback textarea { 
        max-width: 90%; 
      }
    }
  </style>
</head>
<body>
  <div class="header-info">
    <span class="last-updated" id="lastUpdated">Last updated: loading...</span>
    <span class="visitor-count" id="visitorCount">Visitors: Loading...</span>
  </div>
  <div class="header-container">
    <img src="sastik_logo.png" alt="SASTIK Logo" class="logo" onerror="this.style.display='none';console.log('SASTIK logo failed to load');">
    <h2><a href="https://www.facebook.com/sastikofficial/" target="_blank">SASTIK GBQ+</a></h2>
  </div>
  <div class="mission-statement">
    <b>সুস্থ আস্তিকতা প্রচারের উদ্দেশ্যে, হিংসা ও বিদ্বেষের বিরুদ্ধে 🚫 সম্প্রীতি ও মানবতার পক্ষে ✅</b><br>
    <b>To Propagate Sane Theism, Against Hatred and Violence 🚫 In Favor of Harmony and Humanity ✅</b>
  </div>
  <div class="mission-subtext">
    ⬇️ A unified platform offering categorized and filtered theological verses based on modern-day relevance empowering you to wisely apply or disregard teachings and avoid the misguidance of charlatans. ⬇️
  </div>
  <div class="verse-of-day" id="verseOfDay"></div>
  <div class="controls">
    <label for="sheetSelector">Select Gita/Bible/Quran+:</label>
    <select id="sheetSelector" onchange="loadSheetData()">
      <option value="">Select a sheet</option>
      <option value="gita">Gita</option>
      <option value="bible">Bible</option>
      <option value="quran">Quran</option>
      <option value="hadith">Hadith</option>
      <option value="miscellaneous">Miscellaneous</option>
    </select>
    <label for="categoryFilter">Filter by Sloka/Verse/Ayah Category:</label>
    <select id="categoryFilter" disabled onchange="filterTable()">
      <option value="">All</option>
      <option value="Universal or Ethical Verse">Universal or Ethical Verse</option>
      <option value="General Intra-community Verse">General Intra-community Verse</option>
      <option value="Controversial Intra-community Verse">Controversial Intra-community Verse</option>
      <option value="Divisive or Hateful Inter-community Verse">Divisive or Hateful Inter-community Verse</option>
      <option value="Violent or Aggressive Inter-community Verse">Violent or Aggressive Inter-community Verse</option>
    </select>
    <label for="subCategoryFilter">Filter by Sub Category:</label>
    <select id="subCategoryFilter" disabled onchange="filterTable()">
      <option value="">All</option>
      <option value="Historical or Narrative verse">Historical or Narrative verse</option>
      <option value="Discriminatory or Prejudiced Verse">Discriminatory or Prejudiced Verse</option>
      <option value="Metaphorical or Symbolic verse">Metaphorical or Symbolic verse</option>
    </select>
  </div>
  <div class="search-row">
    <div class="content-count" id="contentCount">Content Found: 0</div>
    <div class="search-input-container">
      <input type="text" id="searchInput" placeholder="Search in table..." disabled onkeyup="searchTable()">
    </div>
    <div class="match-count" id="matchCount">Matches found: 0</div>
  </div>
  <table id="verseTable">
    <thead id="tableHeaders"></thead>
    <tbody id="verseBody"></tbody>
  </table>
  <div class="related-verses" id="relatedVerses"></div>
  <div class="overlay" id="overlay"></div>
  <div class="comment-modal" id="commentModal">
    <h3>Add Comment</h3>
    <textarea id="commentText" placeholder="Your comment..."></textarea>
    <button onclick="submitComment()">Submit</button>
    <button onclick="closeCommentModal()">Close</button>
  </div>
  <div class="footer">
    <div class="text-group">
      <div class="support-text">
        <span>Developing and maintaining this unified platform requires continuous effort and dedication.</span>
        <span>We need your support to continue the SASTIK mission, which aims to create a better, harmonious society.</span>
        <span>You can encourage our efforts by scanning the <a href="upi://pay?pa=subhendu.srk1993-1@okicici&pn=Subhendu%20Ghosh&aid=uGICAgIDIy-m-Kw" target="_blank" style="color: #0066cc; text-decoration: none;">UPI QR code</a> below 🙏</span>
      </div>
      <div class="qr-code">
        <a href="upi://pay?pa=subhendu.srk1993-1@okicici&pn=Subhendu%20Ghosh&aid=uGICAgIDIy-m-Kw" target="_blank"><img src="qrcode_logo.jpg" alt="UPI QR Code" onerror="console.log('UPI QR code failed to load')"></a>
      </div>
      <div class="follow-text">For more insights, follow me on 👇</div>
      <div class="logos">
        <a href="https://www.facebook.com/SubhenduGhoshSastik/" target="_blank"><img src="facebook_logo.png" alt="Facebook" onload="console.log('Facebook logo loaded')" onerror="console.log('Facebook logo failed to load')"></a>
        <a href="https://www.youtube.com/@SGSastik" target="_blank"><img src="youtube_logo.png" alt="YouTube" onload="console.log('YouTube logo loaded')" onerror="console.log('YouTube logo failed to load')"></a>
        <a href="https://x.com/subhendug1793" target="_blank"><img src="x_logo.png" alt="X" onload="console.log('X logo loaded')" onerror="console.log('X logo failed to load or fallback to SVG')"></a>
      </div>
      <div class="name-text">Subhendu Ghosh Sastik</div>
      <div class="contact-text">
        <span>If you’d like to contribute to verse updates 📜 or have any suggestions or feedback 💭</span>
        <span>Feel free to connect with <a href="https://m.me/subhendu.ghosh.790349" target="_blank" style="color: #0066cc; text-decoration: none;">me</a> on <a href="https://t.me/Sg1793" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" style="width: 20px; height: auto; vertical-align: middle;"></a> or reach out via email at <a href="mailto:sastikofficial@gmail.com" target="_blank"><img src="gmail_logo.png" alt="Mail" style="width: 20px; height: auto; vertical-align: middle;" onerror="console.log('Gmail logo failed to load')"></a><a href="https://m.me/subhendu.ghosh.790349" target="_blank" style="color: #0066cc; text-decoration: none;">sastikofficial@gmail.com</a></span>
      </div>
      <div class="feedback">
        <h3>Feedback</h3>
        <form id="feedbackForm">
          <textarea name="feedback" placeholder="Share your thoughts..."></textarea>
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCou0LOLpeijDPxHlVN1pvpruvxdrLKVWk",
    authDomain: "verseviewercounter.firebaseapp.com",
    projectId: "verseviewercounter",
    storageBucket: "verseviewercounter.firebasestorage.app",
    messagingSenderId: "486076065573",
    appId: "1:486076065573:web:363e819071b11880089ccc",
    measurementId: "G-NE4PCNMR8D"
  };

  // Initialize Firebase
  let db = null;
  function initializeFirebase() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }
  }

  // Data storage
  let data = [];
  let currentSheet = "";

  function updateLastUpdated() {
    try {
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        console.log("Last updated element found:", lastUpdatedElement.outerHTML);
        let lastUpdated;
        if (document.lastModified && !isNaN(new Date(document.lastModified).getTime())) {
          const date = new Date(document.lastModified);
          const dateStr = date.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = date.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
        } else {
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$1/$2/$3');
          const timeStr = now.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          lastUpdated = `${dateStr} ${timeStr}`;
          console.warn("document.lastModified unavailable, using current date:", lastUpdated);
        }
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">${lastUpdated}</a>`;
        console.log("Last updated set to:", lastUpdated);
      } else {
        console.error("Last updated element NOT found.");
      }
    } catch (error) {
      console.error("Error updating last modified:", error);
      const lastUpdatedElement = document.getElementById("lastUpdated");
      if (lastUpdatedElement) {
        lastUpdatedElement.innerHTML = `Last updated: <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTHaeyqE5JLDS8AuR4x9dgrcX6NoqjdUHpdk0GDI4vUV7PWbmGPFuJRhV108IjxEEM0QBqyFbhyr2Yt/pubhtml" target="_blank">Unknown</a>`;
      }
    }
  }

  async function updateVisitorCount() {
    const visitorCount = document.getElementById("visitorCount");
    if (!visitorCount) {
      console.error("Visitor count element NOT found.");
      return;
    }
    console.log("Visitor count element found:", visitorCount.outerHTML);
    visitorCount.innerHTML = "Visitors: Loading...";

    try {
      if (!db) {
        throw new Error("Firestore not initialized");
      }
      const counterRef = doc(db, "counters", "viewerCount");
      await setDoc(counterRef, { count: increment(1) }, { merge: true });
      console.log("Counter incremented in Firestore");

      const counterSnap = await getDoc(counterRef);
      if (counterSnap.exists()) {
        const count = counterSnap.data().count || 0;
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${count}`;
        console.log("Visitor count updated from Firestore:", count);
      } else {
        throw new Error("Counter document does not exist");
      }
    } catch (error) {
      console.error("Firestore error:", error);
      try {
        const response = await fetch('counter.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`counter.json fetch error: ${response.status}`);
        }
        const data = await response.json();
        console.log("Local counter fetched:", data.visitors);
        visitorCount.classList.remove("error");
        visitorCount.innerHTML = `Visitors: ${data.visitors}`;
        console.log("Visitor count updated from counter.json:", data.visitors);
      } catch (jsonError) {
        console.error("Local counter fetch error:", jsonError);
        visitorCount.innerHTML = "Visitors: 1";
        visitorCount.classList.add("error");
        console.log("Defaulted to Visitors: 1");
      }
    }
  }

  async function loadSheetData() {
    console.log("loadSheetData triggered");
    const sheetSelector = document.getElementById("sheetSelector");
    currentSheet = sheetSelector.value;
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    const errorDisplay = document.createElement("div");
    errorDisplay.id = "errorDisplay";
    errorDisplay.style.color = "red";
    errorDisplay.style.textAlign = "center";
    errorDisplay.style.marginBottom = "10px";
    document.querySelector(".controls").after(errorDisplay);

    if (currentSheet) {
      console.log(`Fetching data for sheet: ${currentSheet}`);
      categoryFilter.disabled = false;
      subCategoryFilter.disabled = false;
      searchInput.disabled = false;
      errorDisplay.textContent = "";
      
      // Try fetching with original case, then lowercase, then uppercase
      const urlsToTry = [`${currentSheet}.json`, `${currentSheet.toLowerCase()}.json`, `${currentSheet.charAt(0).toUpperCase() + currentSheet.slice(1).toLowerCase()}.json`];
      let response, sheetData;
      for (const url of urlsToTry) {
        try {
          console.log(`Attempting to fetch: ${url}`);
          response = await fetch(url, { cache: 'no-store' });
          if (response.ok) {
            sheetData = await response.json();
            console.log(`Data fetched successfully from ${url}:`, sheetData);
            break;
          } else {
            console.warn(`Fetch failed for ${url}: Status ${response.status}`);
          }
        } catch (err) {
          console.warn(`Error fetching ${url}:`, err.message);
        }
      }

      if (sheetData) {
        data = sheetData;
        updateHeaders(currentSheet);
        updateTable(data);
        updateContentCount(data.length);
        updateMatchCount(0);
        displayVerseOfTheDay();
        console.log("Loaded data for sheet:", currentSheet, "Rows:", data.length, "Sample Verse Category:", data[0] ? data[0]["Verse Category "] : "N/A");
      } else {
        console.error(`Failed to load ${currentSheet}.json after trying all URL variants`);
        errorDisplay.textContent = `Error loading ${currentSheet}.json. Please check if the file exists or contact support.`;
        document.getElementById("verseBody").innerHTML = `<tr><td colspan="${Object.keys(data[0] || {}).length || 1}" style="text-align: center;">Error loading ${currentSheet}.json: File not found or inaccessible</td></tr>`;
        updateContentCount(0);
        updateMatchCount(0);
      }
    } else {
      console.log("No sheet selected, clearing table");
      categoryFilter.disabled = true;
      subCategoryFilter.disabled = true;
      searchInput.disabled = true;
      errorDisplay.textContent = "";
      document.getElementById("verseBody").innerHTML = "";
      document.getElementById("tableHeaders").innerHTML = "";
      document.getElementById("verseOfDay").innerHTML = "";
      document.getElementById("relatedVerses").innerHTML = "";
      updateContentCount(0);
      updateMatchCount(0);
    }
  }

  function updateHeaders(sheetName) {
    const thead = document.getElementById("tableHeaders");
    thead.innerHTML = "";
    if (data.length > 0) {
      let tr = document.createElement("tr");
      const headers = Object.keys(data[0]).filter(h => h !== "sheet");
      headers.forEach(header => {
        let th = document.createElement("th");
        th.textContent = header;
        switch (sheetName) {
          case "gita":
            th.classList.add("gita-header");
            break;
          case "bible":
            th.classList.add("bible-header");
            break;
          case "quran":
            th.classList.add("quran-header");
            break;
          case "hadith":
            th.classList.add("hadith-header");
            break;
          case "miscellaneous":
            th.classList.add("miscellaneous-header");
            break;
        }
        tr.appendChild(th);
      });
      // Add headers for comment and share buttons
      tr.appendChild(document.createElement("th")).textContent = "Comment";
      tr.appendChild(document.createElement("th")).textContent = "Share";
      thead.appendChild(tr);
      console.log("Table headers updated for:", sheetName);
    }
  }

  function updateTable(rows) {
    const tbody = document.getElementById("verseBody");
    tbody.innerHTML = "";
    if (rows.length === 0) {
      let tr = document.createElement("tr");
      let td = document.createElement("td");
      td.textContent = "No data available or error loading data";
      td.colSpan = Object.keys(data[0] || {}).length + 2 || 3;
      td.style.textAlign = "center";
      tr.appendChild(td);
      tbody.appendChild(tr);
      console.log("Table updated with no data message");
      document.getElementById("relatedVerses").innerHTML = "";
    } else {
      rows.forEach((row, index) => {
        let tr = document.createElement("tr");
        const headers = Object.keys(row).filter(h => h !== "sheet");
        headers.forEach(header => {
          let td = document.createElement("td");
          let content = row[header] || "";
          if (typeof content === "string" || (typeof content === "object" && content && content.text)) {
            const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
            if (searchTerm && !document.getElementById("searchInput").disabled) {
              const textToSearch = typeof content === "object" ? content.text : content;
              const highlighted = textToSearch.replace(new RegExp(`(${searchTerm})`, 'gi'), '<mark>$1</mark>');
              content = typeof content === "object" ? { text: highlighted, url: content.url } : highlighted;
            }
            td.innerHTML = typeof content === "object" && content.url
              ? `<a href="${content.url}" target="_blank">${content.text}</a>`
              : content;
          } else {
            td.textContent = content || "-";
          }
          if (header === "Verse Category " && typeof row[header] === "string") {
            td.innerHTML = getCategoryClass(row[header].trim().toLowerCase()) + td.innerHTML;
          }
          tr.appendChild(td);
        });
        // Add comment button
        let commentTd = document.createElement("td");
        commentTd.innerHTML = `<button onclick="openCommentModal('${currentSheet}_${index}')">Comment</button>`;
        tr.appendChild(commentTd);
        // Add share buttons
        let shareTd = document.createElement("td");
        shareTd.className = "share-buttons";
        shareTd.innerHTML = addShareButton(row, index);
        tr.appendChild(shareTd);
        tbody.appendChild(tr);
      });
      showRelatedVerses(rows[0]); // Show related verses for the first displayed row
      console.log("Table updated with", rows.length, "rows");
    }
    updateContentCount(rows.length);
  }

  function getCategoryClass(category) {
    const icons = {
      "universal or ethical verse": "🕊️",
      "general intra-community verse": "🙏",
      "controversial intra-community verse": "⚠️",
      "divisive or hateful inter-community verse": "🚫",
      "violent or aggressive inter-community verse": "🔥"
    };
    const className = category.toLowerCase().replace(/ /g, "-");
    return `<span class="category-icon">${icons[category.toLowerCase()] || ""}</span>`;
  }

  function addShareButton(row, index) {
    const verseText = row["Verse"] || row["Text"] || "";
    const shareUrl = `https://subhendug1793.github.io/verse-viewer/?sheet=${currentSheet}&verse=${index}`;
    return `
      <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(verseText)}&url=${encodeURIComponent(shareUrl)}" target="_blank">Twitter</a>
      <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(verseText + ' ' + shareUrl)}" target="_blank">WhatsApp</a>
    `;
  }

  function filterTable() {
    const category = document.getElementById("categoryFilter").value;
    const subCategory = document.getElementById("subCategoryFilter").value;
    const sheetName = document.getElementById("sheetSelector").value;
    const searchInput = document.getElementById("searchInput");
    const searchTerm = searchInput.value.toLowerCase().trim();

    if (sheetName && data.length > 0) {
      let filteredRows = data.filter(row => {
        const categoryMatch = !category || (row["Verse Category "] && typeof row["Verse Category "] === "string" && 
                                          row["Verse Category "].trim().toLowerCase() === category.toLowerCase());
        const subCategoryMatch = !subCategory || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                                row["Sub Category"].trim().toLowerCase() === subCategory.toLowerCase());
        return categoryMatch && subCategoryMatch;
      });
      updateTable(filteredRows);
      if (searchTerm) {
        searchTable();
      } else {
        updateMatchCount(0);
      }
      console.log("Table filtered:", filteredRows.length, "rows");
    }
  }

  function searchTable() {
    const searchInput = document.getElementById("searchInput");
    if (searchInput.disabled) return; 
    const searchTerm = searchInput.value.toLowerCase().trim();
    const category = document.getElementById("categoryFilter").value;
    const subCategory = document.getElementById("subCategoryFilter").value;
    const sheetName = document.getElementById("sheetSelector").value;

    if (sheetName && data.length > 0) {
      let filteredRows = data.filter(row => {
        const categoryMatch = !category || (row["Verse Category "] && typeof row["Verse Category "] === "string" && 
                                          row["Verse Category "].trim().toLowerCase() === category.toLowerCase());
        const subCategoryMatch = !subCategory || (row["Sub Category"] && typeof row["Sub Category"] === "string" && 
                                                row["Sub Category"].trim().toLowerCase() === subCategory.toLowerCase());
        return categoryMatch && subCategoryMatch;
      });

      if (searchTerm) {
        let searchFilteredRows = filteredRows.filter(row =>
          Object.values(row).some(val =>
            (typeof val === "string" && val.toLowerCase().includes(searchTerm)) ||
            (typeof val === "object" && val && val.text && val.text.toLowerCase().includes(searchTerm))
          )
        );
        let matchCount = 0;
        searchFilteredRows.forEach(row => {
          Object.values(row).forEach(val => {
            if (typeof val === "string" && val.toLowerCase().includes(searchTerm)) {
              matchCount += (val.toLowerCase().match(new RegExp(searchTerm, 'g')) || []).length;
            } else if (typeof val === "object" && val && val.text && val.text.toLowerCase().includes(searchTerm)) {
              matchCount += (val.text.toLowerCase().match(new RegExp(searchTerm, 'g')) || []).length;
            }
          });
        });
        updateTable(searchFilteredRows);
        updateMatchCount(matchCount);
        console.log("Search performed on filtered rows, matches found:", matchCount);
      } else {
        updateTable(filteredRows);
        updateMatchCount(0);
        console.log("No search term, showing filtered rows");
      }
    } else {
      updateTable(data);
      updateMatchCount(0);
      console.log("Search cleared or no sheet selected, showing all data");
    }
  }

  async function displayVerseOfTheDay() {
    if (!db || !currentSheet) {
      document.getElementById("verseOfDay").innerHTML = "";
      return;
    }
    try {
      const today = new Date().toISOString().split('T')[0];
      const verseDoc = doc(db, "verse_of_day", today);
      let verse;
      const docSnap = await getDoc(verseDoc);
      if (docSnap.exists()) {
        verse = docSnap.data();
      } else {
        const randomIndex = Math.floor(Math.random() * data.length);
        verse = data[randomIndex];
        await setDoc(verseDoc, { ...verse, sheet: currentSheet });
      }
      const verseDiv = document.getElementById("verseOfDay");
      verseDiv.innerHTML = `<h3>Verse of the Day</h3><p>${verse["Verse"] || verse["Text"] || "No verse available"}</p>`;
    } catch (error) {
      console.error("Error displaying verse of the day:", error);
      document.getElementById("verseOfDay").innerHTML = "";
    }
  }

  function showRelatedVerses(currentRow) {
    if (!currentRow || !data.length) {
      document.getElementById("relatedVerses").innerHTML = "";
      return;
    }
    const category = currentRow["Verse Category "]?.trim().toLowerCase();
    const related = data.filter(row => row["Verse Category "]?.trim().toLowerCase() === category && row !== currentRow).slice(0, 3);
    const relatedDiv = document.getElementById("relatedVerses");
    relatedDiv.innerHTML = "<h3>Related Verses</h3>";
    related.forEach(row => {
      relatedDiv.innerHTML += `<p>${row["Verse"] || row["Text"] || "Verse content"}</p>`;
    });
  }

  function openCommentModal(verseId) {
    const modal = document.getElementById("commentModal");
    const overlay = document.getElementById("overlay");
    modal.classList.add("active");
    overlay.classList.add("active");
    modal.dataset.verseId = verseId;
  }

  async function submitComment() {
    const modal = document.getElementById("commentModal");
    const verseId = modal.dataset.verseId;
    const commentText = document.getElementById("commentText").value;
    if (!db || !commentText) return;
    try {
      await setDoc(doc(db, "verse_comments", verseId), { comment: commentText, timestamp: new Date() }, { merge: true });
      console.log("Comment saved for:", verseId);
      closeCommentModal();
    } catch (error) {
      console.error("Error saving comment:", error);
    }
  }

  function closeCommentModal() {
    const modal = document.getElementById("commentModal");
    const overlay = document.getElementById("overlay");
    modal.classList.remove("active");
    overlay.classList.remove("active");
    document.getElementById("commentText").value = "";
  }

  function updateContentCount(count) {
    document.getElementById("contentCount").textContent = `Content Found: ${count}`;
  }

  function updateMatchCount(count) {
    document.getElementById("matchCount").textContent = `Matches found: ${count}`;
  }

  // Expose functions to global scope
  window.loadSheetData = loadSheetData;
  window.filterTable = filterTable;
  window.searchTable = searchTable;
  window.openCommentModal = openCommentModal;
  window.submitComment = submitComment;
  window.closeCommentModal = closeCommentModal;

  // Initialize on page load
  window.onload = () => {
    console.log("Window loaded, initializing...");
    initializeFirebase();
    updateLastUpdated();
    updateVisitorCount();
    const headerInfo = document.querySelector(".header-info");
    if (headerInfo) {
      const computedStyle = window.getComputedStyle(headerInfo);
      console.log("Header-info visibility:", {
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        opacity: computedStyle.opacity,
        position: computedStyle.position
      });
    }
    // Attach event listeners
    const sheetSelector = document.getElementById("sheetSelector");
    const categoryFilter = document.getElementById("categoryFilter");
    const subCategoryFilter = document.getElementById("subCategoryFilter");
    const searchInput = document.getElementById("searchInput");
    if (sheetSelector) {
      sheetSelector.addEventListener("change", loadSheetData);
      console.log("Event listener attached to sheetSelector");
    }
    if (categoryFilter) {
      categoryFilter.addEventListener("change", filterTable);
    }
    if (subCategoryFilter) {
      subCategoryFilter.addEventListener("change", filterTable);
    }
    if (searchInput) {
      searchInput.addEventListener("keyup", searchTable);
    }
    // Feedback form
    document.getElementById("feedbackForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const feedback = e.target.feedback.value;
      if (db && feedback) {
        try {
          await setDoc(doc(db, "feedback", Date.now().toString()), { feedback, timestamp: new Date() });
          alert("Thank you for your feedback!");
          e.target.reset();
        } catch (error) {
          console.error("Error saving feedback:", error);
        }
      }
    });
    // Mobile table toggle
    document.getElementById("verseBody").addEventListener("click", (e) => {
      if (window.innerWidth <= 600) {
        const tr = e.target.closest("tr");
        if (tr) {
          tr.classList.toggle("expanded");
        }
      }
    });
  };
</script>
</body>
</html>
